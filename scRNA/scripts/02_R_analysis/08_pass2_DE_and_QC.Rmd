---
title: "E. coli Mice scRNAseq"
subtitle: "Differential Expression"
author: "Kennedi Todd"
date: "08/21/2025"
output:
  html_document:
    code_folding: hide
    theme: cerulean
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: inline
---

# Setup
## Set working directory
```{r working_directory}
knitr::opts_knit$set(root.dir = ".")
```

## Load libraries
```{r libraries, message=FALSE, warnings=FALSE}
library(DESeq2)
library(dplyr)      # %>%
library(ggplot2)    # coord_flip()
library(Seurat)     # DimPlot()
library(stringr)    # str_match()
library(ggrepel)    # geom_text_repel()
library(gtools)     # smartbind()
library(tidyr)
```

## Variables and functions
```{r set_variables_and_thresholds}
# source thresholds and output paths
source("../../refs/thresholds_and_outs.R")
out <- paste0(out, "pass2/")

# single cell functions
files <- list.files("../../functions", full.names = TRUE)
invisible(lapply(files, source))
```

## Load data
```{r load_data}
mouse.annotated <- readRDS(paste0("../../rObjects/", filtering_method, "_pass2_annotated_seurat_obj.rds"))
```

## Check
```{r annotated_umap}
cluster_colors <- get_cluster_colors(
  num_clusters = length(unique(mouse.annotated$annotated_clusters)))

DimPlot(mouse.annotated,
        cols = cluster_colors,
        shuffle = TRUE)
```

# Pseudobulk DESeq2
- DESeq2 expects raw (integer) counts as input \
- It automatically estimates size factors to normalize for sequencing depth and library size differences between samples. \
- If you pre-normalize (e.g., CPM, TPM, log-transformed), the internal DESeq2 model becomes invalid — you’ll violate its statistical assumptions. \
## Aggregate counts
```{r aggregate_counts}
# sum counts by cell type and sample
pb_counts <- AggregateExpression(
  mouse.annotated,
  group.by = c("annotated_clusters", "sample"),
  slot = "counts",
  normalization.method = "none",
  return.seurat = FALSE
)$RNA

# get sample meta
sample_meta <- unique(mouse.annotated@meta.data[, c("sample", "group", "group2", 
                                                    "treatment", "timepoint_days",
                                                    "age", "sex")])
rownames(sample_meta) <- sample_meta$sample
```

## Split matrix
```{r split_matrix}
cell_types <- unique(mouse.annotated$annotated_clusters)

split_pb_counts <- lapply(cell_types, function(ct) {
  cols <- grep(paste0("^", ct, "_"), colnames(pb_counts), value = TRUE)
  pb_counts[, cols, drop = FALSE]
})

names(split_pb_counts) <- cell_types

remove(pb_counts)
```

## Define comparisons
```{r define_comparisons}
comparisons <- list(
  c("group2", "E.2D.Y.F", "S.2D.Y.F"),
  c("group2", "E.2D.Y.M", "S.2D.Y.M"),
  c("group2", "E.2D.O.F", "S.2D.O.F"),
  c("group2", "E.2D.O.M", "S.2D.O.M"),
  c("group2", "E.21D.Y.F", "S.21D.Y.F"),
  c("group2", "E.21D.Y.M", "S.21D.Y.M"),
  c("group2", "E.21D.O.F", "S.21D.O.F"),
  c("group2", "E.21D.O.M", "S.21D.O.M"),
  
  c("group2", "E.21D.Y.F", "E.2D.Y.F"),
  c("group2", "E.21D.Y.M", "E.2D.Y.M"),
  c("group2", "E.21D.O.F", "E.2D.O.F"),
  c("group2", "E.21D.O.M", "E.2D.O.M"),
  c("group2", "S.21D.Y.F", "S.2D.Y.F"),
  c("group2", "S.21D.Y.M", "S.2D.Y.M"),
  c("group2", "S.21D.O.F", "S.2D.O.F"),
  c("group2", "S.21D.O.M", "S.2D.O.M"),
  
  c("group2", "E.2D.O.F", "E.2D.Y.F"),
  c("group2", "E.2D.O.M", "E.2D.Y.M"),
  c("group2", "S.2D.O.F", "S.2D.Y.F"),
  c("group2", "S.2D.O.M", "S.2D.Y.M"),
  c("group2", "E.21D.O.F", "E.21D.Y.F"),
  c("group2", "E.21D.O.M", "E.21D.Y.M"),
  c("group2", "S.21D.O.F", "S.21D.Y.F"),
  c("group2", "S.21D.O.M", "S.21D.Y.M"),
  
  c("group2", "E.2D.Y.F", "E.2D.Y.M"),
  c("group2", "E.2D.O.F", "E.2D.O.M"),
  c("group2", "S.2D.Y.F", "S.2D.Y.M"),
  c("group2", "S.2D.O.F", "S.2D.O.M"),
  c("group2", "E.21D.Y.F", "E.21D.Y.M"),
  c("group2", "E.21D.O.F", "E.21D.O.M"),
  c("group2", "S.21D.Y.F", "S.21D.Y.M"),
  c("group2", "S.21D.O.F", "S.21D.O.M"),
  
  # E - S comparisons
  c("group", "E.2D.Y", "S.2D.Y"),
  c("group", "E.21D.Y", "S.21D.Y"),
  c("group", "E.2D.O", "S.2D.O"),
  c("group", "E.21D.O", "S.21D.O"),

  # 21D - 2D comparisons
  c("group", "E.21D.Y", "E.2D.Y"),
  c("group", "S.21D.Y", "S.2D.Y"),
  c("group", "E.21D.O", "E.2D.O"),
  c("group", "S.21D.O", "S.2D.O"),

  # O - Y comparisons
  c("group", "E.2D.O", "E.2D.Y"),
  c("group", "S.2D.O", "S.2D.Y"),
  c("group", "E.21D.O", "E.21D.Y"),
  c("group", "S.21D.O", "S.21D.Y")
)

```

## DE for all cell types
```{r de_all}
for (cmp in comparisons) {
  group_col <- cmp[1]
  g1 <- cmp[2]
  g2 <- cmp[3]

  # Filter metadata for current comparison
  meta_cmp <- sample_meta %>%
    filter(.data[[group_col]] %in% c(g1, g2)) %>%
    distinct(sample, .keep_all = TRUE)

  comparison_results <- list()

  for (ct in cell_types) {
    
    # get cell type counts matrix
    sample_cols <- paste0(ct, "_", meta_cmp$sample)
    pb_counts <- split_pb_counts[[ct]]
    
    # subset cell type matrix based on samples of interest for comparison
    pb_counts <- pb_counts[, colnames(split_pb_counts[[ct]]) %in% sample_cols, drop = FALSE]

    # DESeq2
    res <- DESeq2_per_cell_type(
      cell_type = ct,
      pb_counts = pb_counts,
      sample_meta = meta_cmp,
      group_column = group_col,
      group1 = g1,
      group2 = g2,
      min_counts = 20,
      samples_per_group = NULL
    )

    if (!is.null(res)) {
      comparison_results[[ct]] <- res
    }
  }

  # Combine all cell types for this comparison and write once
  all_res <- do.call(rbind, comparison_results)
  output_file <- file.path(paste0(out, "DEGs/DEG_tables/", g1, "_vs_", g2, "_DEGs.tsv"))
  write.table(all_res, file = output_file, sep = "\t", quote = FALSE, row.names = FALSE)
}
```

# DEG Plots
## Sex Specific Comparisons
### Female vs Male
```{r compare_degs}
# set thresh
adjpval_thresh <- 0.05
lfc_thresh <- 0

# get file paths
files <- list.files(paste0(out, "DEGs_pseudobulk/DEG_tables"))
files <- files[grepl(".+F_vs_.+M_DEGs.tsv", files)]

# init data.frame
deg.df <- data.frame()

# loop through files
for (i in files) {
  
  # read table
  df <- read.table(paste0(out, "DEGs_pseudobulk/DEG_tables/", i),
                   sep = "\t", 
                   header = TRUE)
  
  # filter
  df <- df[!is.na(df$padj),]
  df <- df[df$padj < adjpval_thresh,]
  df <- df[df$log2FoldChange < -lfc_thresh | df$log2FoldChange > lfc_thresh,]
  
  # add direction column
  comparisonName <- gsub("_DEGs.tsv", "", i)
  direction <- df$log2FoldChange > 0 # already filtered on lfc so only matters it's positive/negative
  direction <- gsub(TRUE, paste0(comparisonName, "_up"), direction)
  direction <- gsub(FALSE, paste0(comparisonName, "_down"), direction)
  df$direction <- direction
  
  # reformat table
  df <- df %>% 
    dplyr::count(cell_type, direction) %>%
    tidyr::spread(cell_type, n)
  
  # add to MASTer table
  deg.df <- smartbind(deg.df, df)
}

# reformat
deg.df[is.na(deg.df)] <- 0
rownames(deg.df) <- deg.df$direction
deg.df$direction <- NULL

# save
prefix <- paste0(out, "DEGs_pseudobulk/DEG_comparison/",
                 "female_vs_male_DEG_sex_specific_comparison_FDRq_", 
                 format(adjpval_thresh, nsmall = 2),
                 "_LFC_", format(lfc_thresh, nsmall = 2))
write.table(df, 
            paste0(prefix, ".tsv"),
            sep = "\t", quote = FALSE, row.names = TRUE)

# set heatmap colors and names
paletteLength <- 100
myColor <- colorRampPalette(c("white","#f0eb9e","darkgreen"))(paletteLength)

meta <- data.frame(treatment = c(rep("E.coli", 8),
                                 rep("Saline", 8)),
                   age = c("old","old","young","young","old","old","young","young",
                           "old","old","young","young","old","old","young","young"),
                   time_point = c(rep("21 days", 4), rep("2 days", 4),
                                  rep("21 days", 4), rep("2 days", 4)),
                   direction = c("down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated"))
rownames(meta) <- rownames(deg.df)

ann_colors <- list(treatment = c(`E.coli` = "pink2", Saline = "chocolate4"),
                   
                   age = c(young = "gold",
                           old = "chartreuse2"),
                   time_point = c(`2 days` = "cyan", 
                                  `21 days` = "purple"),
                   direction = c(`down-regulated` = "#0271f0",
                                 `up-regulated` = "tomato"))

# save
pdf(paste0(prefix, ".pdf"), width = 10, height = 10)

# plot
pheatmap::pheatmap(deg.df,
                   main = paste0("Female vs Male, FDRq < ", format(adjpval_thresh, nsmall = 2), 
                                 ", |LFC| > ", format(lfc_thresh, nsmall = 2)),
                   treeheight_row = 0,
                   treeheight_col = 0,
                   color = myColor,
                   cluster_rows = FALSE,
                   annotation_row = meta,
                   annotation_colors = ann_colors,
                   display_numbers = round(deg.df, digits = 0),
                   fontsize_number = 12,
                   number_color = "black")
```

### Old vs Young
```{r old_vs_young_degs, eval=FALSE}
# set thresh
adjpval_thresh <- 0.05
lfc_thresh <- 0

# get file paths
files <- list.files(paste0(out, "DEGs_pseudobulk/DEG_tables"))
files <- files[grepl(".+O.+_vs_.+Y.+_DEGs.tsv", files)]

# init data.frame
deg.df <- data.frame()

# loop through files
for (i in files) {
  
  # read table
  df <- read.table(paste0(out, "DEGs_pseudobulk/DEG_tables/", i),
                   sep = "\t", 
                   header = TRUE)
  
  # filter
  df <- df[!is.na(df$padj),]
  df <- df[df$padj < adjpval_thresh,]
  df <- df[df$log2FoldChange < -lfc_thresh | df$log2FoldChange > lfc_thresh,]
  
  # add direction column
  comparisonName <- gsub("_DEGs.tsv", "", i)
  direction <- df$log2FoldChange > 0 # already filtered on lfc so only matters it's positive/negative
  direction <- gsub(TRUE, paste0(comparisonName, "_up"), direction)
  direction <- gsub(FALSE, paste0(comparisonName, "_down"), direction)
  df$direction <- direction
  
  # reformat table
  df <- df %>% 
    dplyr::count(cell_type, direction) %>%
    tidyr::spread(cell_type, n)
  
  # add to MASTer table
  deg.df <- smartbind(deg.df, df)
}

# reformat
deg.df[is.na(deg.df)] <- 0
rownames(deg.df) <- deg.df$direction
deg.df$direction <- NULL

# save
prefix <- paste0(out, "DEGs_pseudobulk/DEG_comparison/",
                 "old_vs_young_DEG_sex_specific_comparison_FDRq_", 
                 format(adjpval_thresh, nsmall = 2),
                 "_LFC_", format(lfc_thresh, nsmall = 2))
write.table(df, 
            paste0(prefix, ".tsv"),
            sep = "\t", quote = FALSE, row.names = TRUE)

# set heatmap colors and names
paletteLength <- 100
myColor <- colorRampPalette(c("white","#f0eb9e","darkgreen"))(paletteLength)

meta <- data.frame(treatment = c(rep("E.coli", 8),
                                 rep("Saline", 8)),
                   time_point = c(rep("21 days", 4), rep("2 days", 4),
                                  rep("21 days", 4), rep("2 days", 4)),
                   sex = c("female","female","male","male",
                           "female","female","male","male",
                           "female","female","male","male",
                           "female","female","male","male"),
                   direction = c("down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated"))
rownames(meta) <- rownames(deg.df)

ann_colors <- list(treatment = c(`E.coli` = "pink", Saline = "chocolate4"),
                   time_point = c(`2 days` = "cyan", 
                                  `21 days` = "purple"),
                   sex = c(female = "gray",
                           male = "orange"),
                   direction = c(`down-regulated` = "#0271f0",
                                 `up-regulated` = "tomato"))

# save
pdf(paste0(prefix, ".pdf"), width = 10, height = 10)

# plot
pheatmap::pheatmap(deg.df,
                   main = paste0("Old vs. Young, FDRq < ", format(adjpval_thresh, nsmall = 2), 
                                 ", |LFC| > ", format(lfc_thresh, nsmall = 2)),
                   treeheight_row = 0,
                   treeheight_col = 0,
                   color = myColor,
                   cluster_rows = FALSE,
                   annotation_row = meta,
                   annotation_colors = ann_colors,
                   display_numbers = round(deg.df, digits = 0),
                   fontsize_number = 12,
                   number_color = "black")
```

### 21 vs 2 days
```{r old_vs_young_degs, eval=FALSE}
# set thresh
adjpval_thresh <- 0.05
lfc_thresh <- 0

# get file paths
files <- list.files(paste0(out, "DEGs_pseudobulk/DEG_tables"))
files <- files[grepl(".+21D.+[MF]_vs_.+2D.+[MF]_DEGs.tsv", files)]

# init data.frame
deg.df <- data.frame()

# loop through files
for (i in files) {
  
  # read table
  df <- read.table(paste0(out, "DEGs_pseudobulk/DEG_tables/", i),
                   sep = "\t", 
                   header = TRUE)
  
  # filter
  df <- df[!is.na(df$padj),]
  df <- df[df$padj < adjpval_thresh,]
  df <- df[df$log2FoldChange < -lfc_thresh | df$log2FoldChange > lfc_thresh,]
  
  # add direction column
  comparisonName <- gsub("_DEGs.tsv", "", i)
  direction <- df$log2FoldChange > 0 # already filtered on lfc so only matters it's positive/negative
  direction <- gsub(TRUE, paste0(comparisonName, "_up"), direction)
  direction <- gsub(FALSE, paste0(comparisonName, "_down"), direction)
  df$direction <- direction
  
  # reformat table
  df <- df %>% 
    dplyr::count(cell_type, direction) %>%
    tidyr::spread(cell_type, n)
  
  # add to MASTer table
  deg.df <- smartbind(deg.df, df)
}

# reformat
deg.df[is.na(deg.df)] <- 0
rownames(deg.df) <- deg.df$direction
deg.df$direction <- NULL

# save
prefix <- paste0(out, "DEGs_pseudobulk/DEG_comparison/",
                 "21_vs_2_days_DEG_sex_specific_comparison_FDRq_", 
                 format(adjpval_thresh, nsmall = 2),
                 "_LFC_", format(lfc_thresh, nsmall = 2))
write.table(df, 
            paste0(prefix, ".tsv"),
            sep = "\t", quote = FALSE, row.names = TRUE)

# set heatmap colors and names
paletteLength <- 100
myColor <- colorRampPalette(c("white","#f0eb9e","darkgreen"))(paletteLength)

meta <- data.frame(treatment = c(rep("E.coli", 8),
                                 rep("Saline", 8)),
                   age = c(rep("old",4), rep("young",4),
                           rep("old",4), rep("young",4)),
                   sex = c("female","female","male","male",
                           "female","female","male","male",
                           "female","female","male","male",
                           "female","female","male","male"),
                   direction = c("down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated"))
rownames(meta) <- rownames(deg.df)

ann_colors <- list(treatment = c(`E.coli` = "pink", Saline = "chocolate4"),
                   age = c(young = "gold",
                           old = "chartreuse2"),
                   sex = c(female = "gray",
                           male = "orange"),
                   direction = c(`down-regulated` = "#0271f0",
                                 `up-regulated` = "tomato"))


# save
pdf(paste0(prefix, ".pdf"), width = 10, height = 10)

# plot
pheatmap::pheatmap(deg.df,
                   main = paste0("21 vs 2 days, FDRq < ", format(adjpval_thresh, nsmall = 2), 
                                 ", |LFC| > ", format(lfc_thresh, nsmall = 2)),
                   treeheight_row = 0,
                   treeheight_col = 0,
                   color = myColor,
                   cluster_rows = FALSE,
                   annotation_row = meta,
                   annotation_colors = ann_colors,
                   display_numbers = round(deg.df, digits = 0),
                   fontsize_number = 12,
                   number_color = "black")
```


### Ecoli vs saline
```{r old_vs_young_degs, eval=FALSE}
# set thresh
adjpval_thresh <- 0.05
lfc_thresh <- 0

# get file paths
files <- list.files(paste0(out, "DEGs_pseudobulk/DEG_tables"))
files <- files[grepl("E.+[MF]_vs_S.+[MF]_DEGs.tsv", files)]

# init data.frame
deg.df <- data.frame()

# loop through files
for (i in files) {
  
  # read table
  df <- read.table(paste0(out, "DEGs_pseudobulk/DEG_tables/", i),
                   sep = "\t", 
                   header = TRUE)
  
  # filter
  df <- df[!is.na(df$padj),]
  df <- df[df$padj < adjpval_thresh,]
  df <- df[df$log2FoldChange < -lfc_thresh | df$log2FoldChange > lfc_thresh,]
  
  # add direction column
  comparisonName <- gsub("_DEGs.tsv", "", i)
  direction <- df$log2FoldChange > 0 # already filtered on lfc so only matters it's positive/negative
  direction <- gsub(TRUE, paste0(comparisonName, "_up"), direction)
  direction <- gsub(FALSE, paste0(comparisonName, "_down"), direction)
  df$direction <- direction
  
  # reformat table
  df <- df %>% 
    dplyr::count(cell_type, direction) %>%
    tidyr::spread(cell_type, n)
  
  # add to MASTer table
  deg.df <- smartbind(deg.df, df)
}

# reformat
deg.df[is.na(deg.df)] <- 0
rownames(deg.df) <- deg.df$direction
deg.df$direction <- NULL

# save
prefix <- paste0(out, "DEGs_pseudobulk/DEG_comparison/",
                 "ecoli_vs_saline_DEG_comparison_FDRq_", format(adjpval_thresh, nsmall = 2),
                 "_LFC_", format(lfc_thresh, nsmall = 2))
write.table(df, 
            paste0(prefix, ".tsv"),
            sep = "\t", quote = FALSE, row.names = TRUE)

# set heatmap colors and names
paletteLength <- 100
myColor <- colorRampPalette(c("white","#f0eb9e","darkgreen"))(paletteLength)

meta <- data.frame(age = c(rep("old",4), rep("young",4),
                           rep("old",4), rep("young",4)),
                   time_point = c(rep("21 days", 8), rep("2 days", 8)),
                   sex = c("female","female","male","male",
                           "female","female","male","male",
                           "female","female","male","male",
                           "female","female","male","male"),
                   direction = c("down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated"))
rownames(meta) <- rownames(deg.df)

ann_colors <- list(age = c(young = "gold",
                           old = "chartreuse2"),
                   time_point = c(`2 days` = "cyan", 
                                  `21 days` = "purple"),
                   sex = c(female = "gray",
                           male = "orange"),
                   direction = c(`down-regulated` = "#0271f0",
                                 `up-regulated` = "tomato"))


# save
pdf(paste0(prefix, ".pdf"), width = 10, height = 9)

# plot
pheatmap::pheatmap(deg.df,
                   main = paste0("E. coli vs Saline, FDRq < ", format(adjpval_thresh, nsmall = 2), 
                                 ", |LFC| > ", format(lfc_thresh, nsmall = 2)),
                   treeheight_row = 0,
                   treeheight_col = 0,
                   color = myColor,
                   cluster_rows = FALSE,
                   annotation_row = meta,
                   annotation_colors = ann_colors,
                   display_numbers = round(deg.df, digits = 0),
                   fontsize_number = 12,
                   number_color = "black")
```

## Both Sexes Comparisons
### Old vs Young
```{r old_vs_young_degs, eval=FALSE}
# set thresh
adjpval_thresh <- 0.05
lfc_thresh <- 0

# get file paths
files <- list.files(paste0(out, "DEGs_pseudobulk/DEG_tables"))
files <- files[grepl(".+O_vs_.+Y_DEGs.tsv", files)]

# init data.frame
deg.df <- data.frame()

# loop through files
for (i in files) {
  
  # read table
  df <- read.table(paste0(out, "DEGs_pseudobulk/DEG_tables/", i),
                   sep = "\t", 
                   header = TRUE)
  
  # filter
  df <- df[!is.na(df$padj),]
  df <- df[df$padj < adjpval_thresh,]
  df <- df[df$log2FoldChange < -lfc_thresh | df$log2FoldChange > lfc_thresh,]
  
  # add direction column
  comparisonName <- gsub("_DEGs.tsv", "", i)
  direction <- df$log2FoldChange > 0 # already filtered on lfc so only matters it's positive/negative
  direction <- gsub(TRUE, paste0(comparisonName, "_up"), direction)
  direction <- gsub(FALSE, paste0(comparisonName, "_down"), direction)
  df$direction <- direction
  
  # reformat table
  df <- df %>% 
    dplyr::count(cell_type, direction) %>%
    tidyr::spread(cell_type, n)
  
  # add to MASTer table
  deg.df <- smartbind(deg.df, df)
}

# reformat
deg.df[is.na(deg.df)] <- 0
rownames(deg.df) <- deg.df$direction
deg.df$direction <- NULL

# save
prefix <- paste0(out, "DEGs_pseudobulk/DEG_comparison/",
                 "old_vs_young_DEG_both_sexes_comparison_FDRq_", format(adjpval_thresh, nsmall = 2),
                 "_LFC_", format(lfc_thresh, nsmall = 2))
write.table(df, 
            paste0(prefix, ".tsv"),
            sep = "\t", quote = FALSE, row.names = TRUE)

# set heatmap colors and names
paletteLength <- 100
myColor <- colorRampPalette(c("white","#f0eb9e","darkgreen"))(paletteLength)

meta <- data.frame(treatment = c(rep("E.coli", 4),
                                 rep("Saline", 4)),
                   time_point = c(rep("21 days", 2), rep("2 days", 2),
                                  rep("21 days", 2), rep("2 days", 2)),
                   direction = c("down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated"))
rownames(meta) <- rownames(deg.df)

ann_colors <- list(treatment = c(`E.coli` = "pink", Saline = "chocolate4"),
                   time_point = c(`2 days` = "cyan", 
                                  `21 days` = "purple"),
                   direction = c(`down-regulated` = "#0271f0",
                                 `up-regulated` = "tomato"))

# save
pdf(paste0(prefix, ".pdf"), width = 10, height = 6)

# plot
pheatmap::pheatmap(deg.df,
                   main = paste0("Old vs. Young, FDRq < ", format(adjpval_thresh, nsmall = 2), 
                                 ", |LFC| > ", format(lfc_thresh, nsmall = 2)),
                   treeheight_row = 0,
                   treeheight_col = 0,
                   color = myColor,
                   cluster_rows = FALSE,
                   annotation_row = meta,
                   annotation_colors = ann_colors,
                   display_numbers = round(deg.df, digits = 0),
                   fontsize_number = 12,
                   number_color = "black")
```

### 21 vs 2 days
```{r old_vs_young_degs, eval=FALSE}
# set thresh
adjpval_thresh <- 0.05
lfc_thresh <- 0

# get file paths
files <- list.files(paste0(out, "DEGs_pseudobulk/DEG_tables"))
files <- files[grepl(".+21D.+[OY]_vs_.+2D.+[OY]_DEGs.tsv", files)]

# init data.frame
deg.df <- data.frame()

# loop through files
for (i in files) {
  
  # read table
  df <- read.table(paste0(out, "DEGs_pseudobulk/DEG_tables/", i),
                   sep = "\t", 
                   header = TRUE)
  
  # filter
  df <- df[!is.na(df$padj),]
  df <- df[df$padj < adjpval_thresh,]
  df <- df[df$log2FoldChange < -lfc_thresh | df$log2FoldChange > lfc_thresh,]
  
  # add direction column
  comparisonName <- gsub("_DEGs.tsv", "", i)
  direction <- df$log2FoldChange > 0 # already filtered on lfc so only matters it's positive/negative
  direction <- gsub(TRUE, paste0(comparisonName, "_up"), direction)
  direction <- gsub(FALSE, paste0(comparisonName, "_down"), direction)
  df$direction <- direction
  
  # reformat table
  df <- df %>% 
    dplyr::count(cell_type, direction) %>%
    tidyr::spread(cell_type, n)
  
  # add to MASTer table
  deg.df <- smartbind(deg.df, df)
}

# reformat
deg.df[is.na(deg.df)] <- 0
rownames(deg.df) <- deg.df$direction
deg.df$direction <- NULL

# save
prefix <- paste0(out, "DEGs_pseudobulk/DEG_comparison/",
                 "21_vs_2_days_DEG_both_sexes_comparison_FDRq_", format(adjpval_thresh, nsmall = 2),
                 "_LFC_", format(lfc_thresh, nsmall = 2))
write.table(df, 
            paste0(prefix, ".tsv"),
            sep = "\t", quote = FALSE, row.names = TRUE)

# set heatmap colors and names
paletteLength <- 100
myColor <- colorRampPalette(c("white","#f0eb9e","darkgreen"))(paletteLength)

meta <- data.frame(treatment = c(rep("E.coli", 4),
                                 rep("Saline", 4)),
                   age = c(rep("old",2), rep("young",2),
                           rep("old",2), rep("young",2)),
                   direction = c("down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "down-regulated","up-regulated"))
rownames(meta) <- rownames(deg.df)

ann_colors <- list(treatment = c(`E.coli` = "pink", Saline = "chocolate4"),
                   age = c(young = "gold",
                           old = "chartreuse2"),
                   sex = c(female = "gray",
                           male = "orange"),
                   direction = c(`down-regulated` = "#0271f0",
                                 `up-regulated` = "tomato"))


# save
pdf(paste0(prefix, ".pdf"), width = 10, height = 6)

# plot
pheatmap::pheatmap(deg.df,
                   main = paste0("21 vs 2 days, FDRq < ", format(adjpval_thresh, nsmall = 2), 
                                 ", |LFC| > ", format(lfc_thresh, nsmall = 2)),
                   treeheight_row = 0,
                   treeheight_col = 0,
                   color = myColor,
                   cluster_rows = FALSE,
                   annotation_row = meta,
                   annotation_colors = ann_colors,
                   display_numbers = round(deg.df, digits = 0),
                   fontsize_number = 12,
                   number_color = "black")
```


### Ecoli vs saline
```{r both_sexes_ecoli_vs_saline_degs, eval=FALSE}
# set thresh
adjpval_thresh <- 0.05
lfc_thresh <- 0

# get file paths
files <- list.files(paste0(out, "DEGs_pseudobulk/DEG_tables"))
files <- files[grepl("E.+[OY]_vs_S.+[OY]_DEGs.tsv", files)]

# init data.frame
deg.df <- data.frame()

# loop through files
for (i in files) {
  
  # read table
  df <- read.table(paste0(out, "DEGs_pseudobulk/DEG_tables/", i),
                   sep = "\t", 
                   header = TRUE)
  
  # filter
  df <- df[!is.na(df$padj),]
  df <- df[df$padj < adjpval_thresh,]
  df <- df[df$log2FoldChange < -lfc_thresh | df$log2FoldChange > lfc_thresh,]
  
  # add direction column
  comparisonName <- gsub("_DEGs.tsv", "", i)
  direction <- df$log2FoldChange > 0 # already filtered on lfc so only matters it's positive/negative
  direction <- gsub(TRUE, paste0(comparisonName, "_up"), direction)
  direction <- gsub(FALSE, paste0(comparisonName, "_down"), direction)
  df$direction <- direction
  
  # reformat table
  df <- df %>% 
    dplyr::count(cell_type, direction) %>%
    tidyr::spread(cell_type, n)
  
  # add to MASTer table
  deg.df <- smartbind(deg.df, df)
}

# reformat
deg.df[is.na(deg.df)] <- 0
rownames(deg.df) <- deg.df$direction
deg.df$direction <- NULL

# save
prefix <- paste0(out, "DEGs_pseudobulk/DEG_comparison/",
                 "ecoli_vs_saline_DEG_both_sexes_comparison_FDRq_", 
                 format(adjpval_thresh, nsmall = 2),
                 "_LFC_", format(lfc_thresh, nsmall = 2))
write.table(df, 
            paste0(prefix, ".tsv"),
            sep = "\t", quote = FALSE, row.names = TRUE)

# set heatmap colors and names
paletteLength <- 100
myColor <- colorRampPalette(c("white","#f0eb9e","darkgreen"))(paletteLength)

meta <- data.frame(age = c(rep("old",2), rep("young",2),
                           rep("old",1), rep("young",2)),
                   time_point = c(rep("21 days", 4), rep("2 days", 3)),
                   direction = c("down-regulated","up-regulated",
                                 "down-regulated","up-regulated",
                                 "up-regulated",
                                 "down-regulated","up-regulated"))
rownames(meta) <- rownames(deg.df)

ann_colors <- list(age = c(young = "gold",
                           old = "chartreuse2"),
                   time_point = c(`2 days` = "cyan", 
                                  `21 days` = "purple"),
                   direction = c(`down-regulated` = "#0271f0",
                                 `up-regulated` = "tomato"))


# save
pdf(paste0(prefix, ".pdf"), width = 10, height = 6)

# plot
pheatmap::pheatmap(deg.df,
                   main = paste0("E. coli vs Saline, FDRq < ", format(adjpval_thresh, nsmall = 2), 
                                 ", |LFC| > ", format(lfc_thresh, nsmall = 2)),
                   treeheight_row = 0,
                   treeheight_col = 0,
                   color = myColor,
                   cluster_rows = FALSE,
                   annotation_row = meta,
                   annotation_colors = ann_colors,
                   display_numbers = round(deg.df, digits = 0),
                   fontsize_number = 12,
                   number_color = "black")
```

## Volcano
```{r volcano, message=FALSE, eval=FALSE}
# set thresh
adjpval_thresh <- 0.05
lfc_thresh <- 0

# get file paths
files <- list.files(paste0(out, "DEGs_pseudobulk/DEG_tables"), full.names = TRUE)
files <- files[grepl(".+_DEGs.tsv", files)]

for (file in files) {
  
  # read DEG file
  treatment_vs_control <- read.delim(file)
  
  # filter NA values
  treatment_vs_control <- treatment_vs_control[!is.na(treatment_vs_control$padj),]
  
  # extract title for plot later
  p.comparison <- str_match(file, "DEG_tables/(.+)_DEGs.tsv")[,2]
  
  # assign colors
  color_values <- vector()
  max <- nrow(treatment_vs_control)
  for(row in 1:max){
    if (treatment_vs_control$padj[row] < adjpval_thresh){
      if (treatment_vs_control$log2FoldChange [row] > lfc_thresh){
        color_values <- c(color_values, 1) # 1 when logFC > thresh and FDRq < thresh
      } else if (treatment_vs_control$log2FoldChange[row] < -lfc_thresh){
        color_values <- c(color_values, 2) # 2 when logFC < thresh and FDRq < thresh
      } else {
        color_values <- c(color_values, 3) # 2 when FDRq < thresh and LFC not met
      }
    }
    else{
      color_values <- c(color_values, 3) # 3 when FDRq >= thresh
    }
  }
  treatment_vs_control$color_adjpval_thresh <- factor(color_values)
  
  # loop through clusters
  for (j in unique(treatment_vs_control$cell_type)) {
    
    # subset cluster
    data <- subset(treatment_vs_control, cell_type == j)
    
    # plot only if there are DEGs with padj < thresh
    num <- subset(data, padj < adjpval_thresh)
    num <- nrow(num)
    if(num != 0) {
        
      # subset genes to label
      up <- data[data$color_adjpval_thresh == 1,]
      up.sig <- up[order(up$padj),][1:15,]
      up.lfc <- up[order(up$log2FoldChange, decreasing = TRUE),][1:15,]
      up30 <- rbind(up.sig,up.lfc)
      up30 <- unique(up30)
      up30 <- up30[rowSums(is.na(up30)) != ncol(up30), ]
      down <- data[data$color_adjpval_thresh == 2,]
      down.sig <- down[order(down$padj),][1:15,]
      down.lfc <- down[order(down$log2FoldChange, decreasing = FALSE),][1:15,]
      down30 <- rbind(down.sig,down.lfc)
      down30 <- unique(down30)
      down30 <- down30[rowSums(is.na(down30)) != ncol(down30), ]
      
      # set manual colors
      if (!1 %in% unique(data$color_adjpval_thresh)) {
        my_colors <- c("blue","gray")
      } else if (!2 %in% unique(data$color_adjpval_thresh)) {
        my_colors <- c("red","gray")
      } else if (!1 %in% unique(data$color_adjpval_thresh) && !2 %in% unique(data$color_adjpval_thresh)) {
        my_colors <- c("gray")
      } else {
        my_colors <- c("red","blue","gray")
      }
      
      # set significance threshold
      hadjpval <- (-log10(max(
        data$pvalue[data$padj < adjpval_thresh], 
        na.rm=TRUE)))

      # plot
      p <-
        ggplot(data = data, 
               aes(x = log2FoldChange,     # x-axis is logFC
                   y = -log10(pvalue),  # y-axis will be -log10 of P.Value
                   color = color_adjpval_thresh)) +  # color is based on factored color column
        geom_point(alpha = 0.8, size = 2) +  # create scatterplot, alpha makes points transparent
        theme_bw() +  # set color theme
        theme(legend.position = "none") +  # no legend
        scale_color_manual(values = my_colors) +
        labs(
          title = "",
          x = expression(log[2](FC)),
          y = expression(-log[10] ~ "(" ~ italic("p") ~ "-value)")
        ) +
        theme(axis.title.x = element_text(size = 10),
              axis.text.x = element_text(size = 10)) +
        theme(axis.title.y = element_text(size = 10),
              axis.text.y = element_text(size = 10)) +
        geom_hline(yintercept = hadjpval, colour = "#000000", linetype = "dashed") +
        geom_vline(xintercept = lfc_thresh, colour = "#000000", linetype = "dashed") +
        geom_vline(xintercept = -lfc_thresh, colour = "#000000", linetype = "dashed") +
        ggtitle(paste0(j, "\n", p.comparison, ", q < ", format(adjpval_thresh, nsmall = 2), 
                       ", |LFC| > ", format(lfc_thresh, nsmall = 2))) +
        geom_text_repel(data = up30,
                        aes(x = log2FoldChange, y= -log10(pvalue), label = gene), 
                        color = "maroon", 
                        fontface="italic",
                        max.overlaps = getOption("ggrepel.max.overlaps", default = 30)
                        ) +
        geom_text_repel(data = down30,
                        aes(x = log2FoldChange, y= -log10(pvalue), label = gene), 
                        color = "navyblue", 
                        fontface="italic",
                        max.overlaps = getOption("ggrepel.max.overlaps", default = 30)
                        )
      p
      
      # create dir if doesn't exist
      prefix <- paste0(out, "DEGs_pseudobulk/volcano/", p.comparison)
      if (!dir.exists(prefix)) {
        dir.create(prefix, recursive = TRUE)
      }
      
      # save
      j_reformat <- gsub(" / ", "_", j)
      j_reformat <- gsub(" ", "_", j_reformat)
      plot_out <- paste0(prefix, "/", p.comparison, "_", tolower(j_reformat),
                    "_FDRq_", format(adjpval_thresh, nsmall = 2), "_LFC_", 
                    format(lfc_thresh, nsmall = 2), "_volcano.pdf")
      pdf(plot_out, height = 8, width = 8)
      print(p)
      dev.off()
      
      print(paste("comparison =",p.comparison,", cell type =", j))
      
    }
  } # end loop through clusters
} # end loop through variables
```

## Metascape input
```{r metascape_sex_specific}
# set thresh
adjpval_thresh <- 0.05
lfc_thresh <- 0

# get file paths
files <- list.files(paste0(out, "DEGs_pseudobulk/DEG_tables"), full.names = TRUE)
files <- files[grepl(".+_DEGs.tsv", files)]

# loop through files
for (i in 1:length(files)) {
  
  # read table
  data <- read.table(files[i], header = TRUE, sep = "\t")
  
  # filter
  data <- data[!is.na(data$padj),]
  data <- data[data$padj < adjpval_thresh,]
  data <- data[data$log2FoldChange < -lfc_thresh | data$log2FoldChange > lfc_thresh,]
  
  # separate into up and down-regulated
  up.df <- data[data$log2FoldChange > 0,]
  down.df <- data[data$log2FoldChange < 0,]
  
  cell_types <- unique(data$cell_type)
  
  # create dir if doesn't exist
  p.comparison <- str_match(files[i], "DEG_tables/(.+)_DEGs.tsv")[,2]
  prefix <- paste0(out, "DEGs_pseudobulk/metascape_input/", p.comparison)
  if (!dir.exists(prefix)) {
    dir.create(prefix, recursive = TRUE)
  }
  
  # loop through cell_type
  for (j in cell_types) {
    
    # subset based on cell_type
    print(paste0(p.comparison, ": ", j))
    up <- up.df[up.df$cell_type == j,]
    up <- up$gene
    down <- down.df[down.df$cell_type == j,]
    down <- down$gene
    
    # file name
    prefix <- paste0(out, "DEGs_pseudobulk/metascape_input/", p.comparison,
                     "/", p.comparison, "_", gsub(" ", "_", tolower(j)), 
                     "_FDRq_", format(adjpval_thresh, nsmall = 2), 
                     "_LFC_", format(lfc_thresh, nsmall = 2))
     
    # save
    if(length(up) > 10) {
      write.table(x = up,
                  file = paste0(prefix, "_up.tsv"),
                  quote = FALSE,
                  row.names = FALSE,
                  col.names = FALSE)      
    }
    if (length(down) > 10) {
       write.table(x = down,
                file = paste0(prefix, "_down.tsv"),
                quote = FALSE,
                row.names = FALSE,
                col.names = FALSE)   
    }
  } # end j for loop
} # end i for loop
```


## Upset plots
### Function
```{r upset_function}
get_exclusive_intersection_genes <- function(upset_data, list_input) {
  # Initialize a list to store the results
  results <- list()
  
  # Get the names of the columns (gene sets)
  set_names <- colnames(upset_data)
  
  # For each row of the UpSet matrix, extract the exclusive intersection
  for (i in 1:nrow(upset_data)) {
    # Check which sets (columns) are "active" (i.e., 1) for the current row
    active_sets <- set_names[upset_data[i, ] == 1]
    
    if (length(active_sets) > 0) {
      # Find the intersection of genes in the active sets
      intersected_genes <- Reduce(intersect, list_input[active_sets])
      
      # Find genes that are present in any of the other sets (not part of this combination)
      other_sets <- set_names[upset_data[i, ] == 0]
      other_genes <- Reduce(union, list_input[other_sets])
      
      # Subtract the genes that are in the other sets to make the intersection exclusive
      exclusive_genes <- setdiff(intersected_genes, other_genes)
      
      # Create a label for the current intersection (e.g., "Set1 & Set2")
      intersection_label <- paste(active_sets, collapse = " & ")
      
      # Store the number of genes and the exclusive gene list
      results[[intersection_label]] <- list(
        total_genes = length(exclusive_genes),
        gene_list = paste(exclusive_genes, collapse = ", ")
      )
    }
  }
  
  return(results)
}
```

### RRP vs HD sex specifc
```{r E4C_vs_E3C_tables}
# set thresh
thresh <- 0.05

# read tables
prefix <- paste0(out, "DEGs/DEG_tables/")
RRP_F_vs_HD_F <- read.table(paste0(prefix,"RRP_F_vs_HD_F_DEGs.tsv"),
                            sep = "\t",
                            header = TRUE)
RRP_M_vs_HD_M <- read.table(paste0(prefix,"RRP_M_vs_HD_M_DEGs.tsv"),
                            sep = "\t",
                            header = TRUE)

# filter
RRP_F_vs_HD_F <- RRP_F_vs_HD_F[RRP_F_vs_HD_F$padj < thresh,]
RRP_M_vs_HD_M <- RRP_M_vs_HD_M[RRP_M_vs_HD_M$padj < thresh,]
```

```{r upset, eval=FALSE}
# loop through cell types
clusters <- unique(c(RRP_F_vs_HD_F$cluster, RRP_M_vs_HD_M$cluster))

for (i in clusters) {
  
  # skip cluster with not enough DEGs
  #if (i == "cluster") {
  #  next
  #}
  
  # Subset df by cluster
  RRP_F_vs_HD_F_ct <- RRP_F_vs_HD_F[RRP_F_vs_HD_F$cluster == i,]
  RRP_M_vs_HD_M_ct <- RRP_M_vs_HD_M[RRP_M_vs_HD_M$cluster == i,]
  
  # Subset by log2FC
  RRP_F_vs_HD_F_ct_up <- RRP_F_vs_HD_F_ct[RRP_F_vs_HD_F_ct$log2FoldChange > 0,][,"gene"]
  RRP_M_vs_HD_M_ct_up <- RRP_M_vs_HD_M_ct[RRP_M_vs_HD_M_ct$log2FoldChange > 0,][,"gene"]
  RRP_F_vs_HD_F_ct_down <- RRP_F_vs_HD_F_ct[RRP_F_vs_HD_F_ct$log2FoldChange < 0,][,"gene"]
  RRP_M_vs_HD_M_ct_down <- RRP_M_vs_HD_M_ct[RRP_M_vs_HD_M_ct$log2FoldChange < 0,][,"gene"]
  axis_max <- max(length(RRP_F_vs_HD_F_ct_up), length(RRP_M_vs_HD_M_ct_up),
                  length(RRP_F_vs_HD_F_ct_down), length(RRP_M_vs_HD_M_ct_down)) + 300
  axis_max <- ceiling(axis_max / 100) * 100
 
  # format in a list
  list_input <- list(
    "E4CM vs E3CM Down-regulated" = RRP_M_vs_HD_M_ct_down,
    "E4CF vs E3CF Down-regulated" = RRP_F_vs_HD_F_ct_down,
    "E4CM vs E3CM Up-regulated" = RRP_M_vs_HD_M_ct_up,
    "E4CF vs E3CF Up-regulated" = RRP_F_vs_HD_F_ct_up
  )
  data <- UpSetR::fromList(list_input)
  
  # You will specify the male and female groups by their group number
  # Print this to help assign shapes/colors below
  group_mapping <- data.frame(
    Group_Number = 1:4,  # Group numbers (1-8)
    Gene_Set_Name = sort(colnames(data))  # Sorted gene set names
  )
  
  # Assign shapes based on group numbers
  male_groups <- c("3","4")  # Male group numbers
  female_groups <- c("1","2")  # Female group numbers
  
  # Assign colors and shapes based on specific group numbers
  upregulated_groups <- c("2","4")
  downregulated_groups <- c("1","3")
  
  # Create the basic UpSet plot (no dynamic colors or shapes) to extract n_points
  dummy_upset <- ComplexUpset::upset(
    data, 
    colnames(data),  # Use column names (gene sets)
    set_sizes = ComplexUpset::upset_set_size(),  # Display set sizes
    sort_sets = FALSE,
    
    # Plot the intersection matrix with points (default shapes)
    matrix = ComplexUpset::intersection_matrix(
      ggplot2::geom_point(size = 3)  # Simple points without dynamic aesthetics
    )
  )
  
  # Ensure n_points matches the actual data
  n_points <- nrow(dummy_upset$data)
  
  # Create empty vectors for colors and shapes
  color_vector <- rep(NA, n_points)  # To store colors
  shape_vector <- rep(NA, n_points)  # To store shapes
  
  # Assign shapes and colors based on group numbers
  for (j in 1:n_points) {
    group_value <- as.character(dummy_upset$data$group[j])
    
    # Assign shapes
    if (group_value %in% male_groups) {
      shape_vector[j] <- 22  # Filled square for Male comparisons
    } else if (group_value %in% female_groups) {
      shape_vector[j] <- 21  # Circle for Female comparisons
    }
    
    # Assign colors based on group numbers, only if the point is involved in an intersection
    if (dummy_upset$data$value[j]) {  # If the point is part of an intersection
      if (group_value %in% upregulated_groups) {
        color_vector[j] <- "red"  # Red for Up-regulated
      } else if (group_value %in% downregulated_groups) {
        color_vector[j] <- "blue"  # Blue for Down-regulated
      }
    } else {
      color_vector[j] <- NA  # No fill for points not involved in intersections
    }
  }
  
  # Ensure both vectors are of correct length
  if (length(shape_vector) != n_points || length(color_vector) != n_points) {
    stop("Error: shape_vector or color_vector length does not match the number of plotted points.")
  }
  
  # Reintroduce dynamic fill color for filled shapes
  upset_gene <- ComplexUpset::upset(
    data, 
    colnames(data),
    set_sizes = (
      ComplexUpset::upset_set_size() +
      geom_text(aes(label = ..count..), hjust = 1.1, stat = 'count') +
      expand_limits(y = axis_max)
    ),
    
    # Prevent automatic sorting of sets
    sort_sets = FALSE,
    
    matrix = ComplexUpset::intersection_matrix(
      ggplot2::geom_point(
        ggplot2::aes(shape = factor(shape_vector), fill = color_vector),  # Fill shapes with dynamic colors
        size = 3,
        stroke = 0.45  # Keeps the outline black
      )
    ) + ggplot2::scale_shape_manual(
      name = "Sex",
      labels = c("Male", "Female"),  # Legend labels
      values = c(21, 22) # Circle=21, Filled square=22
      ) + ggplot2::scale_fill_identity(na.translate = FALSE),  # Use the exact colors in color_vector and remove NA fill
    
      base_annotations = list(
      'Intersection size' = (
        intersection_size(bar_number_threshold = 1, width = 0.5) +
        scale_y_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, axis_max)) +
        theme(
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.line = element_line(colour = 'black')
        )
      )
    ),
  )
  
  # give title
  upset_gene <- upset_gene + ggtitle(paste0(i,", adj_p_val < 0.05"))
  
  # remove legend
  upset_gene <- upset_gene + theme(legend.position = "None")
  
  # save
  i <- gsub(" ","_",i)
  pdf(paste0(out, "DEGs/upset/", tolower(i), "_upset.pdf"), height = 6, width = 12)
  print(upset_gene)
  dev.off()
}
```

# Ambient contamination
## Heatmap
```{r}
goi <- "Kcnip4"
DefaultAssay(mouse.annotated) <- "RNA"

f1 <- FeaturePlot(mouse.annotated, 
            reduction = "umap",
            features = goi) +
  scale_colour_gradientn(colours = c("blue", "lightblue", "yellow", "orange", "red"))
f1

f2 <- FeaturePlot(mouse.annotated, 
            reduction = "umap", 
            min.cutoff = 2,
            max.cutoff = 50,
            features = goi, 
            slot = "counts") +
  scale_colour_gradientn(colours = c("blue", "lightblue", "yellow", "orange", "red"))
f2
```

## Non-neuronal
### Subset
```{r non_neuronal}
non <- subset(mouse.annotated, merged_clusters != "Neurons")
table(non$merged_clusters)
```

### UMAPs
```{r}
goi <- "Rbfox3"
DefaultAssay(non) <- "RNA"

f1 <- FeaturePlot(non, 
            reduction = "umap",
            features = goi) +
  scale_colour_gradientn(colours = c("blue", "lightblue", "yellow", "orange", "red"))
f1

f2 <- FeaturePlot(non, 
            reduction = "umap", 
            features = goi, 
            slot = "counts") +
  scale_colour_gradientn(colours = c("blue", "lightblue", "yellow", "orange", "red"))
f2

non$keep <- non@assays$RNA$counts[goi,] < 1
f3 <- DimPlot(non, 
              group.by = "keep",
              cols = c("blue","gold"),
              shuffle = TRUE,
              reduction = "umap")
f3
```

```{r}
goi <- "Rbfox3"
summary(non@assays$RNA$counts[goi,])
table(non@assays$RNA$counts[goi,] > 1)
table(non@assays$RNA$counts[goi,] > 2)
table(non@assays$RNA$counts[goi,] > 3)
table(non@assays$RNA$counts[goi,] > 4)
```

### Barcodes
```{r}
# subset noisy clusters
non$keep <- non@assays$RNA$counts["Rbfox3",] < 1
noise <- subset(non, keep == FALSE)

# check
table(noise$keep)

# get barcodes of noisy clusters
barcodes <- colnames(noise)

# save
saveRDS(barcodes, 
        file = paste0("../../rObjects/", filtering_method,
                      "_pass2_neuronal_cell_barcodes_to_remove.rds"),
        compress = FALSE)
```


## Neuronal
### subset
```{r}
neuro <- subset(mouse.annotated, merged_clusters == "Neurons")
table(neuro$merged_clusters)
```

```{r}
goi <- "Mbp"
DefaultAssay(neuro) <- "RNA"

f1 <- FeaturePlot(neuro, 
            reduction = "umap",
            features = goi) +
  scale_colour_gradientn(colours = c("blue", "lightblue", "yellow", "orange", "red"))
f1

f2 <- FeaturePlot(neuro, 
            reduction = "umap", 
            features = goi, 
            slot = "counts") +
  scale_colour_gradientn(colours = c("blue", "lightblue", "yellow", "orange", "red"))
f2

neuro$keep <- neuro@assays$RNA$counts[goi,] < 1
table(neuro$keep)
f3 <- DimPlot(neuro, 
              group.by = "keep",
              cols = c("blue","gold"),
              shuffle = TRUE,
              reduction = "umap")
f3

neuro$keep <- neuro@assays$RNA$counts[goi,] < 5
table(neuro$keep)
f4 <- DimPlot(neuro, 
              group.by = "keep",
              cols = c("blue","gold"),
              shuffle = TRUE,
              reduction = "umap")
f4
```

### Barcodes
```{r}
# subset noisy clusters
neuro$keep <- neuro@assays$RNA$counts["Mbp",] < 5
noise <- subset(neuro, keep == FALSE)

# check
table(noise$keep)

# get barcodes of noisy clusters
barcodes <- colnames(noise)
length(barcodes)

# save
saveRDS(barcodes, 
        file = paste0("../../rObjects/", filtering_method,
                      "_pass2_mbp_cell_barcodes_to_remove.rds"),
        compress = FALSE)
```

# Plotting biases
```{r heatmap_bias}
goi <- "Meg3"
f1 <- FeaturePlot(mouse.annotated, 
            reduction = "umap", 
            features = goi, 
            slot = "data") +
  scale_colour_gradientn(colours = c("blue", "lightblue", "yellow", "orange", "red"))
f1

f2 <- FeaturePlot(mouse.annotated, 
            reduction = "umap", 
            features = goi, 
            slot = "counts") +
  scale_colour_gradientn(colours = c("blue", "lightblue", "yellow", "orange", "red"))
f2

f3 <- FeaturePlot(mouse.annotated, 
            reduction = "umap", 
            features = goi, 
            slot = "counts", 
            min.cutoff = 5, 
            max.cutoff = 100) +  # adjust based on your data
  scale_colour_gradientn(colours = c("blue", "lightblue", "yellow", "orange", "red"))
f3
```

## Dot plot
```{r}
canonical_markers <- c(
  "Aldoc", "Aqp4", "Gja1", "Clu", "Apoe",             # Astrocytes
  "Col1a1", "Col1a2", "Dcn",                          # Fibroblast
  "Ptprb", "Cldn5", "Flt1",                           # Endothelial
  "Aif1", "C1qa", "P2ry12", "Tmem119","Trem2","Mrc1", # Microglia
  "Syt1", "Snap25", "Rbfox3",                         # Neurons
  "Pdgfra", "Cspg4", "Olig1", "Olig2", "Tnr",         # OPCs
  "Mog", "Opalin", "Mal", "Mag", "Mbp",               # Oligodendrocytes
  "Cfap44", "Spag16","Folr1","Ttr")                   # Ependymal

d1 <- DotPlot(mouse.annotated,
              features = canonical_markers,
              cols = "RdYlBu",
              assay = "RNA") +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
d1

d2 <- DotPlot(mouse.annotated,
              features = canonical_markers,
              cols = "RdYlBu",
              assay = "RNA",
              col.min = NA,
              col.max = NA) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
d2

d3 <- DotPlot(mouse.annotated,
              features = canonical_markers,
              cols = "RdYlBu",
              assay = "RNA",
              slot = "counts",
              scale = FALSE) +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
d3
```
