---
title: "E. coli Mice bulkRNAseq"
subtitle: "Figures"
author: "Kennedi Todd"
date: "02/23/2024"
output:
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: inline
---

# Setup
## Working directory
```{r setup}
knitr::opts_knit$set(root.dir = ".")
```

## Libraries
```{r libraries, message=FALSE, warning=FALSE}
library(plotly)
library(tidyr)
library(ComplexUpset)
library(UpSetR)
library(gridExtra)
library(ggrepel)
```

## Functions
```{r get_exclusiver_intersection_genes}
get_exclusive_intersection_genes <- function(upset_data, list_input) {
  # Initialize a list to store the results
  results <- list()
  
  # Get the names of the columns (gene sets)
  set_names <- colnames(upset_data)
  
  # For each row of the UpSet matrix, extract the exclusive intersection
  for (i in 1:nrow(upset_data)) {
    # Check which sets (columns) are "active" (i.e., 1) for the current row
    active_sets <- set_names[upset_data[i, ] == 1]
    
    if (length(active_sets) > 0) {
      # Find the intersection of genes in the active sets
      intersected_genes <- Reduce(intersect, list_input[active_sets])
      
      # Find genes that are present in any of the other sets (not part of this combination)
      other_sets <- set_names[upset_data[i, ] == 0]
      other_genes <- Reduce(union, list_input[other_sets])
      
      # Subtract the genes that are in the other sets to make the intersection exclusive
      exclusive_genes <- setdiff(intersected_genes, other_genes)
      
      # Create a label for the current intersection (e.g., "Set1 & Set2")
      intersection_label <- paste(active_sets, collapse = " & ")
      
      # Store the number of genes and the exclusive gene list
      results[[intersection_label]] <- list(
        total_genes = length(exclusive_genes),
        gene_list = paste(exclusive_genes, collapse = ", ")
      )
    }
  }
  
  return(results)
}
```

# Z-score heatmap
## 2 days, both sexes, CPM
### Z-score log2CPM
```{r}
# load data
dge_obj <- readRDS(
  "../rObjects/DGEList_filtered_normalized.rds"
)

# get log CPM
log_cpm <- cpm(dge_obj, log = TRUE, prior.count = 0.5)

# mean and SD across all samples per gene
gene_mean <- rowMeans(log_cpm)
gene_sd   <- apply(log_cpm, 1, sd)

# get mean log CPM per group per gene
meta <- dge_obj$samples[,c("sample","group")]
group_list <- split(colnames(log_cpm), meta$group)
group_means <- sapply(group_list, function(samps) {
    rowMeans(log_cpm[, samps, drop = FALSE])
})

# z-score
group_z <- sweep(group_means, 1, gene_mean, "-")
group_z <- sweep(group_z, 1, gene_sd, "/")
group_z <- as.data.frame(group_z)

# save table
write.table(x = group_z,
            file = "../results/figures/zscore_log2CPM_per_group.tsv",
            quote = FALSE,
            sep = "\t",
            row.names = TRUE,
            col.names = TRUE)

# cleanup
remove(dge_obj, group_list, group_means, log_cpm, meta)
```

### Plot
```{r}
# subset to groups of interest
group_z <- group_z[,c("S.2D.Y", "E.2D.Y", "S.2D.O", "E.2D.O")]

# subset to genes of interest
genes <- readLines("../refs/2D_both_sexes_zscore_log2CPM_heatmap_genes.tsv")
group_z <- group_z[genes,]

# set heatmap colors
paletteLength <- 100
p_color_scale <- colorRampPalette(c("cornflowerblue", "white", "red"))(paletteLength)
p_breaks <- c(seq(min(group_z), 0, length.out = ceiling(paletteLength/2) + 1), 
              seq(max(group_z)/paletteLength, max(group_z), length.out = floor(paletteLength/2)))

# get heatmap annotation
p_meta <- read.delim2("../refs/heatmap_gene_categories.tsv")
rownames(p_meta) <- p_meta$gene_name
p_meta <- p_meta[rownames(group_z),]
p_ann_colors <- list(gene_category = c(`immune` = "cornflowerblue",
                                       `proliferative` = "gold",
                                       `endothelial` = "chartreuse3",
                                       `metabolic` = "firebrick2"))

# save
pdf("../results/figures/2D_both_sexes_zscore_log2CPM_heatmap.pdf", 
    width = 5, height = 6)
#png(paste0(out, "custom_figures/heatmap1.png"), width = 4000, height = 4800, res = 600)
pheatmap::pheatmap(group_z,
                   main = "Z-scored Log2(CPM)",
                   cluster_rows = FALSE,
                   cluster_cols = FALSE,
                   angle_col = 0,
                   color = p_color_scale,
                   breaks = p_breaks)
```

## 2 days, sex-specific, CPM
### Z-score log2CPM
```{r}
# load data
dge_obj <- readRDS(
  "../rObjects/DGEList_filtered_normalized.rds"
)

# get log CPM
log_cpm <- cpm(dge_obj, log = TRUE, prior.count = 0.5)

# mean and SD across all samples per gene
gene_mean <- rowMeans(log_cpm)
gene_sd   <- apply(log_cpm, 1, sd)

# get mean log CPM per group2 per gene
meta <- dge_obj$samples[,c("sample","group2")]
group2_list <- split(colnames(log_cpm), meta$group2)
group2_means <- sapply(group2_list, function(samps) {
    rowMeans(log_cpm[, samps, drop = FALSE])
})

# z-score
group2_z <- sweep(group2_means, 1, gene_mean, "-")
group2_z <- sweep(group2_z, 1, gene_sd, "/")
group2_z <- as.data.frame(group2_z)

# save table
write.table(x = group2_z,
            file = "../results/figures/zscore_log2CPM_per_group2.tsv",
            quote = FALSE,
            sep = "\t",
            row.names = TRUE,
            col.names = TRUE)

# clean up
remove(dge_obj, group2_list, group2_means, log_cpm, meta)
```

### Plot
```{r}
# subset to groups of interest
group2_z <- group2_z[,c("S.2D.Y.F", "E.2D.Y.F", "S.2D.Y.M", "E.2D.Y.M",
                        "S.2D.O.F", "E.2D.O.F", "S.2D.O.M", "E.2D.O.M",
                        "S.21D.Y.F", "E.21D.Y.F", "S.21D.Y.M", "E.21D.Y.M",
                        "S.21D.O.F","E.21D.O.F", "S.21D.O.M", "E.21D.O.M")]

group2_z <- group2_z[,c("E.2D.Y.F", "E.2D.Y.M",
                        "E.2D.O.F", "E.2D.O.M",
                        "E.21D.Y.F", "E.21D.Y.M",
                        "E.21D.O.F", "E.21D.O.M")]

# subset to genes of interest
genes <- readLines("../refs/sex_specific_zscore_log2CPM_heatmap_genes.tsv")
group2_z <- group2_z[genes,]

# set heatmap colors
paletteLength <- 100
p_color_scale <- colorRampPalette(c("cornflowerblue", "white", "red"))(paletteLength)
p_breaks <- c(seq(min(group2_z), 0, length.out = ceiling(paletteLength/2) + 1), 
              seq(max(group2_z)/paletteLength, max(group2_z), length.out = floor(paletteLength/2)))

# save
pdf("../results/figures/sex_specific_zscore_log2CPM_heatmap.pdf",
    width = 12, height = 6)
    
pheatmap::pheatmap(group2_z,
                   main = "Z-scored Log2(CPM)",
                   cluster_rows = FALSE,
                   cluster_cols = FALSE,
                   angle_col = 45,
                   color = p_color_scale,
                   annotation_row = p_ann_colors,
                   breaks = p_breaks)
```

# Fold change heatmaps
## 2 days with pval
- sex specific filtering but both sexes comparison \
- FDRq < 0.05 and LFC=0 \
- Heatmap for 2-day timepoints \
```{r}
# save path
out <- "../results/both_sexes/"

# genes of interest
goi_2D <- c("S100a8","Lcn2","S100a9","Ctla2a","Lrg1","Top2a","Pkn3","Igsf6",
            "Srarp","Cd52","Edn1","Vil1","Rhoh","Tmem252","Vwf","Myct1",
            "Clec14a","Lyz1","Fermt1","Gpr160","Tnfsf10","Slc38a5","Ctss",
            "Ly6a","C1qa","C1qb","C1qc","Csf3r","Mpeg1","Vim","Pecam1",
            "Adgre1","Itgam","Hif3a","Sgk1","Smox","Mfsd2a","Ly6c1","Tcim")

# get DEG files
files <- list.files(paste0(out, "DEGs_with_hbb/DEG_tables/"))
files <- files[grep("E.2D.+_vs_S.2D.+_1.00_LFC_0.00.tsv", files)]

# init
lfc.df <- data.frame(row.names = goi_2D)
adjpval.df <- data.frame(row.names = goi_2D)

for (i in seq_along(files)) {
  # read table
  data <- read.delim(
    file = paste0(out, "DEGs_with_hbb/DEG_tables/", files[i]),
    sep = "\t", check.names = FALSE
  )

  # comparison name
  comparison <- sub("_FDRq_1.00_LFC_0.00\\.tsv$", "", files[i])

  # filter + order to goi_2D
  data <- data[data$gene_name %in% goi_2D, c("gene_name","logFC", "adj.P.Val")]
  rownames(data) <- data$gene_name
  data <- data[match(goi_2D, rownames(data)), , drop = FALSE]

  # ensure numeric (in case it was read as character)
  data$logFC <- round(as.numeric(data$logFC), 4)
  data$adj.P.Val <- as.numeric(data$adj.P.Val)

  # assign just the logFC column
  lfc.df[[comparison]] <- data$logFC
  adjpval.df[[comparison]] <- data$adj.P.Val
}

# set heatmap colors and names
paletteLength <- 100
myColor <- colorRampPalette(c("cornflowerblue", "white", "red"))(paletteLength)
myBreaks <- c(seq(min(lfc.df), 0, length.out = ceiling(paletteLength/2) + 1), 
              seq(max(lfc.df)/paletteLength, max(lfc.df), length.out = floor(paletteLength/2)))

# save
pdf(paste0(out, "custom_figures/2D_logFC_adjPVal_heatmap.pdf"), width = 5, height = 10)


pheatmap::pheatmap(lfc.df,
                   main = "logFC and adj.P.Val for 2 Day Time Points",
                   cluster_rows = FALSE,
                   cluster_cols = FALSE,
                   annotation_colors = ann_colors,
                   color = myColor,
                   breaks = myBreaks,
                   display_numbers = round(adjpval.df, digits = 4),
                   fontsize_number = 12,
                   number_color = "black",
                   )
```

# Sex specific upset
## 2 day E.coli vs saline with baseline
### Plot
```{r}
# set variables
thresh <- 0.05
myLfc <- 0
model <- "DEGs_with_hbb/"
out <- "../results/sex_specific/"

# read tables
S2DYF_vs_S2DYM <- read.delim(
  paste0("../results/sex_specific/", 
         model, "DEG_tables/S.2D.Y.F_vs_S.2D.Y.M_FDRq_1.00_LFC_0.00.tsv"))
E2DYF_vs_E2DYM <- read.delim(
  paste0("../results/sex_specific/", 
         model, "DEG_tables/E.2D.Y.F_vs_E.2D.Y.M_FDRq_1.00_LFC_0.00.tsv"))
S2DOF_vs_S2DOM <- read.delim(
  paste0("../results/sex_specific/", 
         model, "DEG_tables/S.2D.O.F_vs_S.2D.O.M_FDRq_1.00_LFC_0.00.tsv"))
E2DOF_vs_E2DOM <- read.delim(
  paste0("../results/sex_specific/", 
         model, "DEG_tables/E.2D.O.F_vs_E.2D.O.M_FDRq_1.00_LFC_0.00.tsv"))

# set row names
rownames(S2DYF_vs_S2DYM) <- S2DYF_vs_S2DYM$gene_name_unique
rownames(E2DYF_vs_E2DYM) <- E2DYF_vs_E2DYM$gene_name_unique
rownames(S2DOF_vs_S2DOM) <- S2DOF_vs_S2DOM$gene_name_unique
rownames(E2DOF_vs_E2DOM) <- E2DOF_vs_E2DOM$gene_name_unique

# filter on pval
S2DYF_vs_S2DYM <- S2DYF_vs_S2DYM[S2DYF_vs_S2DYM$adj.P.Val < thresh,]
E2DYF_vs_E2DYM <- E2DYF_vs_E2DYM[E2DYF_vs_E2DYM$adj.P.Val < thresh,]
S2DOF_vs_S2DOM <- S2DOF_vs_S2DOM[S2DOF_vs_S2DOM$adj.P.Val < thresh,]
E2DOF_vs_E2DOM <- E2DOF_vs_E2DOM[E2DOF_vs_E2DOM$adj.P.Val < thresh,]

# up/down-reg
S2DYF_vs_S2DYM_up <- subset(S2DYF_vs_S2DYM$gene_name_unique, S2DYF_vs_S2DYM$logFC > myLfc)
S2DYF_vs_S2DYM_dn <- subset(S2DYF_vs_S2DYM$gene_name_unique, S2DYF_vs_S2DYM$logFC < -myLfc)
E2DYF_vs_E2DYM_up <- subset(E2DYF_vs_E2DYM$gene_name_unique, E2DYF_vs_E2DYM$logFC > myLfc)
E2DYF_vs_E2DYM_dn <- subset(E2DYF_vs_E2DYM$gene_name_unique, E2DYF_vs_E2DYM$logFC < -myLfc)
S2DOF_vs_S2DOM_up <- subset(S2DOF_vs_S2DOM$gene_name_unique, S2DOF_vs_S2DOM$logFC > myLfc)
S2DOF_vs_S2DOM_dn <- subset(S2DOF_vs_S2DOM$gene_name_unique, S2DOF_vs_S2DOM$logFC < -myLfc)
E2DOF_vs_E2DOM_up <- subset(E2DOF_vs_E2DOM$gene_name_unique, E2DOF_vs_E2DOM$logFC > myLfc)
E2DOF_vs_E2DOM_dn <- subset(E2DOF_vs_E2DOM$gene_name_unique, E2DOF_vs_E2DOM$logFC < -myLfc)

# create list
list_input <- list("E.2D.O.F vs E.2D.O.M up-regulated" = E2DOF_vs_E2DOM_up,
                   "E.2D.O.F vs E.2D.O.M down-regulated" = E2DOF_vs_E2DOM_dn,
                   "S.2D.O.F vs S.2D.O.M up-regulated" = S2DOF_vs_S2DOM_up,
                   "S.2D.O.F vs S.2D.O.M down-regulated" = S2DOF_vs_S2DOM_dn,
                   "E.2D.Y.F vs E.2D.Y.M up-regulated" = E2DYF_vs_E2DYM_up,
                   "E.2D.Y.F vs E.2D.Y.M down-regulated" = E2DYF_vs_E2DYM_dn,
                   "S.2D.Y.F vs S.2D.Y.M up-regulated" = S2DYF_vs_S2DYM_up,
                   "S.2D.Y.F vs S.2D.Y.M down-regulated" = S2DYF_vs_S2DYM_dn)
data <- fromList(list_input)
  
# store names
names <- colnames(data)
  
# plot
upset_gene <- ComplexUpset::upset(data, 
				  names,
				  set_sizes=(
					upset_set_size()
					+ geom_text(aes(label=..count..), hjust=1.1, stat='count')
					+ expand_limits(y=2000)),
				  queries = list(upset_query("E.2D.O.F vs E.2D.O.M up-regulated", fill = "red"),
								 upset_query("E.2D.O.F vs E.2D.O.M down-regulated", fill = "blue"),
								 upset_query("S.2D.O.F vs S.2D.O.M up-regulated", fill = "red"),
								 upset_query("S.2D.O.F vs S.2D.O.M down-regulated", fill = "blue"),
								 upset_query("E.2D.Y.F vs E.2D.Y.M up-regulated", fill = "red"),
								 upset_query("E.2D.Y.F vs E.2D.Y.M down-regulated", fill = "blue"),
								 upset_query("S.2D.Y.F vs S.2D.Y.M up-regulated", fill = "red"),
								 upset_query("S.2D.Y.F vs S.2D.Y.M down-regulated", fill = "blue")),
				  base_annotations = list('Intersection size' = (
					intersection_size(bar_number_threshold=1, width=0.5)
					+ scale_y_continuous(expand=expansion(mult=c(0, 0.05)),limits = c(0,1600)) # space on top
					+ theme(
						  # hide grid lines
						  panel.grid.major=element_blank(),
						  panel.grid.minor=element_blank(),
						  # show axis lines
						  axis.line=element_line(colour='black')))),
				  stripes = upset_stripes(
					geom=geom_segment(size=12),  # make the stripes larger
					colors=c('grey95', 'white')),
				  # to prevent connectors from getting the colorured
				  # use `fill` instead of `color`, together with `shape='circle filled'`
				  matrix = intersection_matrix(
					geom=geom_point(
					  shape='circle filled',
					  size=3,
					  stroke=0.45)),
				  sort_sets=FALSE,
				  sort_intersections='descending'
				)

upset_gene <- upset_gene + ggtitle(paste0("FDRq < ", format(thresh, nsmall = 2),
                                          ", |LFC| > ", format(myLfc, nsmall = 2)))

# save
pdf(paste0(out, model, "/upset/2_day_female_vs_male_with_baseline_FDRq_", format(thresh, nsmall = 2), 
           "_LFC_", format(myLfc, nsmall = 2), ".pdf"), 
    height = 6, width = 10)
upset_gene
```

### Extract
```{r}
# convert the gene sets into a binary matrix (like UpSet plot input)
upset_data <- UpSetR::fromList(list_input)

# call the function to extract the exclusive intersection genes
exclusive_intersection_results <- get_exclusive_intersection_genes(upset_data, list_input)

# convert the list to a data.frame with two columns: Total genes and gene list
exclusive_intersection_df <- do.call(rbind, lapply(names(exclusive_intersection_results), function(x) {
  data.frame(
    Intersection = x,
    Total_Genes = exclusive_intersection_results[[x]]$total_genes,
    Gene_List = exclusive_intersection_results[[x]]$gene_list,
    stringsAsFactors = FALSE
  )
}))
exclusive_intersection_df <- 
  exclusive_intersection_df[order(exclusive_intersection_df$Total_Genes, decreasing = TRUE),]

# save
write.table(x = exclusive_intersection_df,
            file = paste0(out, model,
                          "/upset/2_day_female_vs_male_with_baseline_FDRq_",
                          format(thresh, nsmall = 2), "_LFC_", format(myLfc, nsmall = 2), 
                          "_results.tsv"),
            sep = "\t",
            quote = FALSE,
            col.names = TRUE,
            row.names = FALSE)
```

## 2 day E.coli vs saline
### Plot
```{r}
# set variables
thresh <- 0.05
myLfc <- 0
model <- "DEGs_with_hbb/"
out <- "../results/sex_specific/"

# get file list
files <- list.files(paste0(out, model, "metascape_input"))
files <- files[grepl(pattern = "^E.+2D.+[FM]_vs_S.+2D.+[MF].+_FDRq_0.05.+", x = files)]

# loop through files and create variable for each gene list
for (i in files) {
  genes <- readLines(paste0(out, model, "metascape_input/", i))
  genes <- genes[genes != ""]
  var_name <- gsub(pattern = "regulated_FDRq_0.05_LFC_0.00.txt",
                   replacement = "",
                   x = i)
  assign(x = var_name, value = genes)
}

# format in a list
list_input <- list(
  "E.2D.O.M vs S.2D.O.M up-regulated" = E.2D.O.M_vs_S.2D.O.M_up,
  "E.2D.O.M vs S.2D.O.M down-regulated" = E.2D.O.M_vs_S.2D.O.M_down,
  "E.2D.O.F vs S.2D.O.F up-regulated" = E.2D.O.F_vs_S.2D.O.F_up,
  "E.2D.O.F vs S.2D.O.F down-regulated" = E.2D.O.F_vs_S.2D.O.F_down,
  "E.2D.Y.M vs S.2D.Y.M up-regulated" = E.2D.Y.M_vs_S.2D.Y.M_up,
  "E.2D.Y.M vs S.2D.Y.M down-regulated" = E.2D.Y.M_vs_S.2D.Y.M_down,
  "E.2D.Y.F vs S.2D.Y.F up-regulated" = E.2D.Y.F_vs_S.2D.Y.F_up,
  "E.2D.Y.F vs S.2D.Y.F down-regulated" = E.2D.Y.F_vs_S.2D.Y.F_down
)
data <- UpSetR::fromList(list_input)

# You will specify the male and female groups by their group number
group_mapping <- data.frame(
  Group_Number = 1:8,  # Group numbers
  Gene_Set_Name = sort(colnames(data))  # Sorted gene set names
)
group_mapping

# Assign shapes based on group numbers
male_groups <- c("3","4","7","8")  # Male group numbers
female_groups <- c("1","2","5","6")  # Female group numbers

# Assign colors and shapes based on specific group numbers
upregulated_groups <- c("2","4","6","8")
downregulated_groups <- c("1","3","5","7")

# Create the basic UpSet plot (no dynamic colors or shapes) to extract n_points
dummy_upset <- ComplexUpset::upset(
  data, 
  colnames(data),  # Use column names (gene sets)
  set_sizes = ComplexUpset::upset_set_size(),  # Display set sizes
  sort_sets = FALSE,
  
  # Plot the intersection matrix with points (default shapes)
  matrix = ComplexUpset::intersection_matrix(
    ggplot2::geom_point(size = 3)  # Simple points without dynamic aesthetics
  )
)

# Ensure n_points matches the actual data
n_points <- nrow(dummy_upset$data)
print(paste("Number of points being plotted:", n_points))  # Should be 300

# Create empty vectors for colors and shapes
color_vector <- rep(NA, n_points)  # To store colors
shape_vector <- rep(NA, n_points)  # To store shapes

# Assign shapes and colors based on group numbers
for (i in 1:n_points) {
  group_value <- as.character(dummy_upset$data$group[i])
  
  # Assign shapes
  if (group_value %in% male_groups) {
    shape_vector[i] <- 22  # Filled square for Male comparisons
  } else if (group_value %in% female_groups) {
    shape_vector[i] <- 21  # Circle for Female comparisons
  }
  
  # Assign colors based on group numbers, only if the point is involved in an intersection
  if (dummy_upset$data$value[i]) {  # If the point is part of an intersection
    if (group_value %in% upregulated_groups) {
      color_vector[i] <- "red"  # Red for Up-regulated
    } else if (group_value %in% downregulated_groups) {
      color_vector[i] <- "blue"  # Blue for Down-regulated
    }
  } else {
    color_vector[i] <- NA  # No fill for points not involved in intersections
  }
}

# Ensure both vectors are of correct length
if (length(shape_vector) != n_points || length(color_vector) != n_points) {
  stop("Error: shape_vector or color_vector length does not match the number of plotted points.")
}

# Print the color_vector to ensure correctness before plotting
print(unique(color_vector))  # Ensure this contains only valid colors or NA

# Reintroduce dynamic fill color for filled shapes
upset_gene <- ComplexUpset::upset(
  data, 
  colnames(data),
  set_sizes = (
    ComplexUpset::upset_set_size() +
    geom_text(aes(label = ..count..), hjust = 1.1, stat = 'count') +
    expand_limits(y = 750)
  ),
  
  # Prevent automatic sorting of sets
  sort_sets = FALSE,
  
  matrix = ComplexUpset::intersection_matrix(
    ggplot2::geom_point(
      ggplot2::aes(shape = factor(shape_vector), fill = color_vector),  # Fill shapes with dynamic colors
      size = 3,
      stroke = 0.45  # Keeps the outline black
    )
  ) + ggplot2::scale_shape_manual(
    name = "Sex",
    labels = c("Male", "Female"),  # Legend labels
    values = c(21, 22) # Circle=21, Filled square=22
    ) + ggplot2::scale_fill_identity(na.translate = FALSE),  # Use the exact colors in color_vector and remove NA fill
  
    base_annotations = list(
    'Intersection size' = (
      intersection_size(bar_number_threshold = 1, width = 0.5) +
      scale_y_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 500)) +
      theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = 'black')
      )
    )
  ),
)

# Add title
upset_gene <- upset_gene + 
  ggtitle("FDRq < 0.05")

# Remove legend
upset_gene <- upset_gene + theme(legend.position = "None")

# Save temp without legend
pdf(file = paste0(out, model, "/upset/2_day_ecoli_vs_saline_FDRq_0.05_LFC_0.00.pdf"), 
    height = 7, 
    width = 12)
upset_gene
```

### Extract
```{r}
# convert the gene sets into a binary matrix (like UpSet plot input)
upset_data <- UpSetR::fromList(list_input)

# call the function to extract the exclusive intersection genes
exclusive_intersection_results <- get_exclusive_intersection_genes(upset_data, list_input)

# convert the list to a data.frame with two columns: Total genes and gene list
exclusive_intersection_df <- do.call(rbind, lapply(names(exclusive_intersection_results), function(x) {
  data.frame(
    Intersection = x,
    Total_Genes = exclusive_intersection_results[[x]]$total_genes,
    Gene_List = exclusive_intersection_results[[x]]$gene_list,
    stringsAsFactors = FALSE
  )
}))
exclusive_intersection_df <- 
  exclusive_intersection_df[order(exclusive_intersection_df$Total_Genes, decreasing = TRUE),]

# save
write.table(x = exclusive_intersection_df,
            file = paste0(out, model, "/upset/2_day_ecoli_vs_saline_FDRq_0.05_LFC_0.00_results.tsv"),
            sep = "\t",
            quote = FALSE,
            col.names = TRUE,
            row.names = FALSE)
```


# Both sexes upset
## E.coli vs saline, 2 days
### Plot
```{r}
# set variables
thresh <- 0.05
myLfc <- 0
model <- "DEGs_with_hbb/"

# read tables
E2DY_vs_S2DY <- read.delim(
  paste0("../results/both_sexes/", 
         model, "DEG_tables/E.2D.Y_vs_S.2D.Y_FDRq_1.00_LFC_0.00.tsv"))
E2DO_vs_S2DO <- read.delim(
  paste0("../results/filtered_samples_both_sexes/", 
         model, "DEG_tables/E.2D.O_vs_S.2D.O_FDRq_1.00_LFC_0.00.tsv"))
rownames(E2DY_vs_S2DY) <- E2DY_vs_S2DY$gene_name_unique
rownames(E2DO_vs_S2DO) <- E2DO_vs_S2DO$gene_name_unique

# filter on pval
E2DY_vs_S2DY <- E2DY_vs_S2DY[E2DY_vs_S2DY$adj.P.Val < thresh,]
E2DO_vs_S2DO <- E2DO_vs_S2DO[E2DO_vs_S2DO$adj.P.Val < thresh,]

# Subset lists
E2DY_vs_S2DY_up <- subset(E2DY_vs_S2DY$gene_name_unique, E2DY_vs_S2DY$logFC > myLfc)
E2DY_vs_S2DY_down <- subset(E2DY_vs_S2DY$gene_name_unique, E2DY_vs_S2DY$logFC < -myLfc)
E2DO_vs_S2DO_up <- subset(E2DO_vs_S2DO$gene_name_unique, E2DO_vs_S2DO$logFC > myLfc)
E2DO_vs_S2DO_down <- subset(E2DO_vs_S2DO$gene_name_unique, E2DO_vs_S2DO$logFC < -myLfc)
list_input <- list("E.2D.O vs S.2D.O up-regulated" = E2DO_vs_S2DO_up,
                   "E.2D.Y vs S.2D.Y up-regulated" = E2DY_vs_S2DY_up,
                   "E.2D.O vs S.2D.O down-regulated" = E2DO_vs_S2DO_down,
                   "E.2D.Y vs S.2D.Y down-regulated" = E2DY_vs_S2DY_down)
data <- fromList(list_input)
  
# store names
names <- colnames(data)
  
# plot
upset_gene <- ComplexUpset::upset(data, 
				  names,
				  set_sizes=(
					upset_set_size()
					+ geom_text(aes(label=..count..), hjust=1.1, stat='count')
					+ expand_limits(y=400)),
				  queries = list(upset_query("E.2D.O vs S.2D.O up-regulated", fill = "red"),
								 upset_query("E.2D.Y vs S.2D.Y up-regulated", fill = "red"),
								 upset_query("E.2D.O vs S.2D.O down-regulated", fill = "blue"),
								 upset_query("E.2D.Y vs S.2D.Y down-regulated", fill = "blue")),
				  base_annotations = list('Intersection size' = (
					intersection_size(bar_number_threshold=1, width=0.5)
					+ scale_y_continuous(expand=expansion(mult=c(0, 0.05)),limits = c(0,1000)) # space on top
					+ theme(
						  # hide grid lines
						  panel.grid.major=element_blank(),
						  panel.grid.minor=element_blank(),
						  # show axis lines
						  axis.line=element_line(colour='black')))),
				  stripes = upset_stripes(
					geom=geom_segment(size=12),  # make the stripes larger
					colors=c('grey95', 'white')),
				  # to prevent connectors from getting the colorured
				  # use `fill` instead of `color`, together with `shape='circle filled'`
				  matrix = intersection_matrix(
					geom=geom_point(
					  shape='circle filled',
					  size=3,
					  stroke=0.45)),
				  sort_sets=FALSE,
				  sort_intersections='descending'
				)

upset_gene <- upset_gene + ggtitle(paste0("E.2D vs S.2D, FDRq < ", format(thresh, nsmall = 2),
                                          ", |LFC| > ", format(myLfc, nsmall = 2)))

# save
pdf(paste0("../results/both_sexes/",
           model, "upset/E.2D_vs_S.2D_both_sexes_FDRq_", 
           format(thresh, nsmall = 2), "_LFC_", format(myLfc, nsmall = 2), "_upset.pdf"), 
    height = 6, width = 10)
upset_gene
```

### Extract
```{r}
# convert the gene sets into a binary matrix (like UpSet plot input)
upset_data <- UpSetR::fromList(list_input)

# call the function to extract the exclusive intersection genes
exclusive_intersection_results <- get_exclusive_intersection_genes(upset_data, list_input)

# convert the list to a data.frame with two columns: Total genes and gene list
exclusive_intersection_df <- do.call(rbind, lapply(names(exclusive_intersection_results), function(x) {
  data.frame(
    Intersection = x,
    Total_Genes = exclusive_intersection_results[[x]]$total_genes,
    Gene_List = exclusive_intersection_results[[x]]$gene_list,
    stringsAsFactors = FALSE
  )
}))
exclusive_intersection_df <- 
  exclusive_intersection_df[order(exclusive_intersection_df$Total_Genes, decreasing = TRUE),]

# save
write.table(x = exclusive_intersection_df,
            file = paste0("../results/both_sexes/",
                          model, "upset/E.2D_vs_S.2D_both_sexes_FDRq_", 
                          format(thresh, nsmall = 2), "_LFC_", format(myLfc, nsmall = 2), 
                          "_results.tsv"),
            sep = "\t",
            quote = FALSE,
            col.names = TRUE,
            row.names = FALSE)
```

## E.coli vs saline, 21 days, both sexes
### Plot
```{r}
# set variables
thresh <- 0.05
myLfc <- 0
model <- "DEGs_with_hbb/"

# read tables
E21DY_vs_S21DY <- read.delim(
  paste0("../results/both_sexes/", 
         model, "DEG_tables/E.21D.Y_vs_S.21D.Y_FDRq_1.00_LFC_0.00.tsv"))
E21DO_vs_S21DO <- read.delim(
  paste0("../results/filtered_samples_both_sexes/", 
         model, "DEG_tables/E.21D.O_vs_S.21D.O_FDRq_1.00_LFC_0.00.tsv"))
rownames(E21DY_vs_S21DY) <- E21DY_vs_S21DY$gene_name_unique
rownames(E21DO_vs_S21DO) <- E21DO_vs_S21DO$gene_name_unique

# filter on pval
E21DY_vs_S21DY <- E21DY_vs_S21DY[E21DY_vs_S21DY$adj.P.Val < thresh,]
E21DO_vs_S21DO <- E21DO_vs_S21DO[E21DO_vs_S21DO$adj.P.Val < thresh,]

# Subset lists
E21DY_vs_S21DY_up <- subset(E21DY_vs_S21DY$gene_name_unique, E21DY_vs_S21DY$logFC > myLfc)
E21DY_vs_S21DY_down <- subset(E21DY_vs_S21DY$gene_name_unique, E21DY_vs_S21DY$logFC < -myLfc)
E21DO_vs_S21DO_up <- subset(E21DO_vs_S21DO$gene_name_unique, E21DO_vs_S21DO$logFC > myLfc)
E21DO_vs_S21DO_down <- subset(E21DO_vs_S21DO$gene_name_unique, E21DO_vs_S21DO$logFC < -myLfc)
list_input <- list("E.21D.O vs S.21D.O up-regulated" = E21DO_vs_S21DO_up,
                   "E.21D.Y vs S.21D.Y up-regulated" = E21DY_vs_S21DY_up,
                   "E.21D.O vs S.21D.O down-regulated" = E21DO_vs_S21DO_down,
                   "E.21D.Y vs S.21D.Y down-regulated" = E21DY_vs_S21DY_down)
data <- fromList(list_input)
  
# store names
names <- colnames(data)
  
# plot
upset_gene <- ComplexUpset::upset(data, 
				  names,
				  set_sizes=(
					upset_set_size()
					+ geom_text(aes(label=..count..), hjust=1.1, stat='count')
					+ expand_limits(y=400)),
				  queries = list(upset_query("E.21D.O vs S.21D.O up-regulated", fill = "red"),
								 upset_query("E.21D.Y vs S.21D.Y up-regulated", fill = "red"),
								 upset_query("E.21D.O vs S.21D.O down-regulated", fill = "blue"),
								 upset_query("E.21D.Y vs S.21D.Y down-regulated", fill = "blue")),
				  base_annotations = list('Intersection size' = (
					intersection_size(bar_number_threshold=1, width=0.5)
					+ scale_y_continuous(expand=expansion(mult=c(0, 0.05)),limits = c(0,1000)) # space on top
					+ theme(
						  # hide grid lines
						  panel.grid.major=element_blank(),
						  panel.grid.minor=element_blank(),
						  # show axis lines
						  axis.line=element_line(colour='black')))),
				  stripes = upset_stripes(
					geom=geom_segment(size=12),  # make the stripes larger
					colors=c('grey95', 'white')),
				  # to prevent connectors from getting the colorured
				  # use `fill` instead of `color`, together with `shape='circle filled'`
				  matrix = intersection_matrix(
					geom=geom_point(
					  shape='circle filled',
					  size=3,
					  stroke=0.45)),
				  sort_sets=FALSE,
				  sort_intersections='descending'
				)

upset_gene <- upset_gene + ggtitle(paste0("E.21D vs S.21D, FDRq < ", format(thresh, nsmall = 2),
                                          ", |LFC| > ", format(myLfc, nsmall = 2)))

# save
pdf(paste0("../results/both_sexes/",
           model, "upset/E.21D_vs_S.21D_both_sexes_FDRq_", 
           format(thresh, nsmall = 2), "_LFC_", format(myLfc, nsmall = 2), "_upset.pdf"), 
    height = 6, width = 10)
upset_gene
```

### Extract
```{r}
# convert the gene sets into a binary matrix (like UpSet plot input)
upset_data <- UpSetR::fromList(list_input)

# call the function to extract the exclusive intersection genes
exclusive_intersection_results <- get_exclusive_intersection_genes(upset_data, list_input)

# convert the list to a data.frame with two columns: Total genes and gene list
exclusive_intersection_df <- do.call(rbind, lapply(names(exclusive_intersection_results), function(x) {
  data.frame(
    Intersection = x,
    Total_Genes = exclusive_intersection_results[[x]]$total_genes,
    Gene_List = exclusive_intersection_results[[x]]$gene_list,
    stringsAsFactors = FALSE
  )
}))
exclusive_intersection_df <- 
  exclusive_intersection_df[order(exclusive_intersection_df$Total_Genes, decreasing = TRUE),]

# save
write.table(x = exclusive_intersection_df,
            file = paste0("../results/both_sexes/",
                          model, "upset/E.21D_vs_S.21D_both_sexes_FDRq_", 
                          format(thresh, nsmall = 2), "_LFC_", format(myLfc, nsmall = 2), 
                          "_results.tsv"),
            sep = "\t",
            quote = FALSE,
            col.names = TRUE,
            row.names = FALSE)
```


## E.coli vs saline, both sexes
### Plot
```{r}
# set variables
thresh <- 0.05
myLfc <- 0
model <- "DEGs_with_hbb/"

# read tables
E2DY_vs_S2DY <- read.delim(
  paste0("../results/both_sexes/", 
         model, "DEG_tables/E.2D.Y_vs_S.2D.Y_FDRq_1.00_LFC_0.00.tsv"))
E2DO_vs_S2DO <- read.delim(
  paste0("../results/filtered_samples_both_sexes/", 
         model, "DEG_tables/E.2D.O_vs_S.2D.O_FDRq_1.00_LFC_0.00.tsv"))
E21DY_vs_S21DY <- read.delim(
  paste0("../results/both_sexes/", 
         model, "DEG_tables/E.21D.Y_vs_S.21D.Y_FDRq_1.00_LFC_0.00.tsv"))
E21DO_vs_S21DO <- read.delim(
  paste0("../results/filtered_samples_both_sexes/", 
         model, "DEG_tables/E.21D.O_vs_S.21D.O_FDRq_1.00_LFC_0.00.tsv"))

rownames(E2DY_vs_S2DY) <- E2DY_vs_S2DY$gene_name_unique
rownames(E2DO_vs_S2DO) <- E2DO_vs_S2DO$gene_name_unique
rownames(E21DY_vs_S21DY) <- E21DY_vs_S21DY$gene_name_unique
rownames(E21DO_vs_S21DO) <- E21DO_vs_S21DO$gene_name_unique

# filter on pval
E2DY_vs_S2DY <- E2DY_vs_S2DY[E2DY_vs_S2DY$adj.P.Val < thresh,]
E2DO_vs_S2DO <- E2DO_vs_S2DO[E2DO_vs_S2DO$adj.P.Val < thresh,]
E21DY_vs_S21DY <- E21DY_vs_S21DY[E21DY_vs_S21DY$adj.P.Val < thresh,]
E21DO_vs_S21DO <- E21DO_vs_S21DO[E21DO_vs_S21DO$adj.P.Val < thresh,]

# Subset lists
E2DY_vs_S2DY_up <- subset(E2DY_vs_S2DY$gene_name_unique, E2DY_vs_S2DY$logFC > myLfc)
E2DY_vs_S2DY_down <- subset(E2DY_vs_S2DY$gene_name_unique, E2DY_vs_S2DY$logFC < -myLfc)
E2DO_vs_S2DO_up <- subset(E2DO_vs_S2DO$gene_name_unique, E2DO_vs_S2DO$logFC > myLfc)
E2DO_vs_S2DO_down <- subset(E2DO_vs_S2DO$gene_name_unique, E2DO_vs_S2DO$logFC < -myLfc)
E21DY_vs_S21DY_up <- subset(E21DY_vs_S21DY$gene_name_unique, E21DY_vs_S21DY$logFC > myLfc)
E21DY_vs_S21DY_down <- subset(E21DY_vs_S21DY$gene_name_unique, E21DY_vs_S21DY$logFC < -myLfc)
E21DO_vs_S21DO_up <- subset(E21DO_vs_S21DO$gene_name_unique, E21DO_vs_S21DO$logFC > myLfc)
E21DO_vs_S21DO_down <- subset(E21DO_vs_S21DO$gene_name_unique, E21DO_vs_S21DO$logFC < -myLfc)
list_input <- list("E.21D.O vs S.21D.O up-regulated" = E21DO_vs_S21DO_up,
                   "E.21D.Y vs S.21D.Y up-regulated" = E21DY_vs_S21DY_up,
                   "E.21D.O vs S.21D.O down-regulated" = E21DO_vs_S21DO_down,
                   "E.21D.Y vs S.21D.Y down-regulated" = E21DY_vs_S21DY_down,
                   "E.2D.O vs S.2D.O up-regulated" = E2DO_vs_S2DO_up,
                   "E.2D.Y vs S.2D.Y up-regulated" = E2DY_vs_S2DY_up,
                   "E.2D.O vs S.2D.O down-regulated" = E2DO_vs_S2DO_down,
                   "E.2D.Y vs S.2D.Y down-regulated" = E2DY_vs_S2DY_down)
data <- fromList(list_input)
  
# store names
names <- colnames(data)
  
# plot
upset_gene <- ComplexUpset::upset(data, 
				  names,
				  set_sizes=(
					upset_set_size()
					+ geom_text(aes(label=..count..), hjust=1.1, stat='count')
					+ expand_limits(y=400)),
				  queries = list(upset_query("E.21D.O vs S.21D.O up-regulated", fill = "red"),
								 upset_query("E.21D.Y vs S.21D.Y up-regulated", fill = "red"),
								 upset_query("E.21D.O vs S.21D.O down-regulated", fill = "blue"),
								 upset_query("E.21D.Y vs S.21D.Y down-regulated", fill = "blue"),
								 upset_query("E.2D.O vs S.2D.O up-regulated", fill = "red"),
								 upset_query("E.2D.Y vs S.2D.Y up-regulated", fill = "red"),
								 upset_query("E.2D.O vs S.2D.O down-regulated", fill = "blue"),
								 upset_query("E.2D.Y vs S.2D.Y down-regulated", fill = "blue")),
				  base_annotations = list('Intersection size' = (
					intersection_size(bar_number_threshold=1, width=0.5)
					+ scale_y_continuous(expand=expansion(mult=c(0, 0.05)),limits = c(0,250)) # space on top
					+ theme(
						  # hide grid lines
						  panel.grid.major=element_blank(),
						  panel.grid.minor=element_blank(),
						  # show axis lines
						  axis.line=element_line(colour='black')))),
				  stripes = upset_stripes(
					geom=geom_segment(size=12),  # make the stripes larger
					colors=c('grey95', 'white')),
				  # to prevent connectors from getting the colorured
				  # use `fill` instead of `color`, together with `shape='circle filled'`
				  matrix = intersection_matrix(
					geom=geom_point(
					  shape='circle filled',
					  size=3,
					  stroke=0.45)),
				  sort_sets=FALSE,
				  sort_intersections='descending'
				)

upset_gene <- upset_gene + ggtitle(paste0("E. coli vs Saline, FDRq < ", format(thresh, nsmall = 2),
                                          ", |LFC| > ", format(myLfc, nsmall = 2)))

# save
pdf(paste0("../results/both_sexes/",
           model, "upset/E_vs_S_both_sexes_FDRq_", 
           format(thresh, nsmall = 2), "_LFC_", format(myLfc, nsmall = 2), "_upset.pdf"), 
    height = 6, width = 10)
upset_gene
```

### Extract
```{r}
# convert the gene sets into a binary matrix (like UpSet plot input)
upset_data <- UpSetR::fromList(list_input)

# call the function to extract the exclusive intersection genes
exclusive_intersection_results <- get_exclusive_intersection_genes(upset_data, list_input)

# convert the list to a data.frame with two columns: Total genes and gene list
exclusive_intersection_df <- do.call(rbind, lapply(names(exclusive_intersection_results), function(x) {
  data.frame(
    Intersection = x,
    Total_Genes = exclusive_intersection_results[[x]]$total_genes,
    Gene_List = exclusive_intersection_results[[x]]$gene_list,
    stringsAsFactors = FALSE
  )
}))
exclusive_intersection_df <- 
  exclusive_intersection_df[order(exclusive_intersection_df$Total_Genes, decreasing = TRUE),]

# save
write.table(x = exclusive_intersection_df,
            file = paste0("../results/both_sexes/",
                          model, "upset/E.2D_vs_S.2D_both_sexes_FDRq_", 
                          format(thresh, nsmall = 2), "_LFC_", format(myLfc, nsmall = 2), 
                          "_results.tsv"),
            sep = "\t",
            quote = FALSE,
            col.names = TRUE,
            row.names = FALSE)
```
## E.2D.O vs S.2D.O
### Plot
```{r}
# set variables
thresh <- 0.05
myLfc <- 0
model <- "DEGs_with_hbb/"

# read tables
ss_filt <- read.delim(
  paste0("../results/both_sexes/", 
         model, "DEG_tables/E.2D.O_vs_S.2D.O_FDRq_1.00_LFC_0.00.tsv"))
bs_filt <- read.delim(
  paste0("../results/filtered_samples_both_sexes/", 
         model, "DEG_tables/E.2D.O_vs_S.2D.O_FDRq_1.00_LFC_0.00.tsv"))
rownames(ss_filt) <- ss_filt$gene_name_unique
rownames(bs_filt) <- bs_filt$gene_name_unique

# filter on pval
ss_filt <- ss_filt[ss_filt$adj.P.Val < thresh,]
bs_filt <- bs_filt[bs_filt$adj.P.Val < thresh,]

# Subset lists
ss_filt.up <- subset(ss_filt$gene_name_unique, ss_filt$logFC > myLfc)
ss_filt.down <- subset(ss_filt$gene_name_unique, ss_filt$logFC < -myLfc)
bs_filt.up <- subset(bs_filt$gene_name_unique, bs_filt$logFC > myLfc)
bs_filt.down <- subset(bs_filt$gene_name_unique, bs_filt$logFC < -myLfc)
list_input <- list("both sexes filtering, up-regulated" = bs_filt.up,
                   "sex specific filtering, up-regulated" = ss_filt.up,
                   "both sexes filtering, down-regulated" = bs_filt.down,
                   "sex specific filtering, down-regulated" = ss_filt.down)
data <- fromList(list_input)
  
# store names
names <- colnames(data)
  
# plot
upset_gene <- ComplexUpset::upset(data, 
				  names,
				  set_sizes=(
					upset_set_size()
					+ geom_text(aes(label=..count..), hjust=1.1, stat='count')
					+ expand_limits(y=400)),
				  queries = list(upset_query("both sexes filtering, up-regulated", fill = "red"),
								 upset_query("sex specific filtering, up-regulated", fill = "red"),
								 upset_query("8 hr Low Dose Psilocybin vs Saline Down-regulated", fill = "blue"),
								 upset_query("both sexes filtering, down-regulated", fill = "blue"),
								 upset_query("sex specific filtering, down-regulated", fill = "blue")),
				  base_annotations = list('Intersection size' = (
					intersection_size(bar_number_threshold=1, width=0.5)
					+ scale_y_continuous(expand=expansion(mult=c(0, 0.05)),limits = c(0,350)) # space on top
					+ theme(
						  # hide grid lines
						  panel.grid.major=element_blank(),
						  panel.grid.minor=element_blank(),
						  # show axis lines
						  axis.line=element_line(colour='black')))),
				  stripes = upset_stripes(
					geom=geom_segment(size=12),  # make the stripes larger
					colors=c('grey95', 'white')),
				  # to prevent connectors from getting the colorured
				  # use `fill` instead of `color`, together with `shape='circle filled'`
				  matrix = intersection_matrix(
					geom=geom_point(
					  shape='circle filled',
					  size=3,
					  stroke=0.45)),
				  sort_sets=FALSE,
				  sort_intersections='descending'
				)

upset_gene <- upset_gene + ggtitle(paste0("E.2D.O vs S.2D.O, FDRq < ", format(thresh, nsmall = 2),
                                          ", |LFC| > ", format(myLfc, nsmall = 2)))

# save
pdf(paste0("../results/filtering_comparison/E.2D.O_vs_S.2D.O_FDRq_", format(thresh, nsmall = 2), 
           "_LFC_", format(myLfc, nsmall = 2), "_upset.pdf"), 
    height = 6, width = 10)
upset_gene
```

### Extract
```{r}
# convert the gene sets into a binary matrix (like UpSet plot input)
upset_data <- UpSetR::fromList(list_input)

# call the function to extract the exclusive intersection genes
exclusive_intersection_results <- get_exclusive_intersection_genes(upset_data, list_input)

# convert the list to a data.frame with two columns: Total genes and gene list
exclusive_intersection_df <- do.call(rbind, lapply(names(exclusive_intersection_results), function(x) {
  data.frame(
    Intersection = x,
    Total_Genes = exclusive_intersection_results[[x]]$total_genes,
    Gene_List = exclusive_intersection_results[[x]]$gene_list,
    stringsAsFactors = FALSE
  )
}))
exclusive_intersection_df <- 
  exclusive_intersection_df[order(exclusive_intersection_df$Total_Genes, decreasing = TRUE),]

# save
write.table(x = exclusive_intersection_df,
            file = paste0("../results/filtering_comparison/E.2D.O_vs_S.2D.O_FDRq_", 
                          format(thresh, nsmall = 2), "_LFC_", format(myLfc, nsmall = 2), 
                          "_results.tsv"),
            sep = "\t",
            quote = FALSE,
            col.names = TRUE,
            row.names = FALSE)
```


## E.21D.Y vs S.21D.Y
### Plot
```{r}
# set variables
thresh <- 0.05
myLfc <- 0
model <- "DEGs_with_hbb/"

# read tables
ss_filt <- read.delim(
  paste0("../results/both_sexes/", 
         model, "DEG_tables/E.21D.Y_vs_S.21D.Y_FDRq_1.00_LFC_0.00.tsv"))
bs_filt <- read.delim(
  paste0("../results/filtered_samples_both_sexes/", 
         model, "DEG_tables/E.21D.Y_vs_S.21D.Y_FDRq_1.00_LFC_0.00.tsv"))
rownames(ss_filt) <- ss_filt$gene_name_unique
rownames(bs_filt) <- bs_filt$gene_name_unique

# filter on pval
ss_filt <- ss_filt[ss_filt$adj.P.Val < thresh,]
bs_filt <- bs_filt[bs_filt$adj.P.Val < thresh,]

# Subset lists
ss_filt.up <- subset(ss_filt$gene_name_unique, ss_filt$logFC > myLfc)
ss_filt.down <- subset(ss_filt$gene_name_unique, ss_filt$logFC < -myLfc)
bs_filt.up <- subset(bs_filt$gene_name_unique, bs_filt$logFC > myLfc)
bs_filt.down <- subset(bs_filt$gene_name_unique, bs_filt$logFC < -myLfc)
list_input <- list("both sexes filtering, up-regulated" = bs_filt.up,
                   "sex specific filtering, up-regulated" = ss_filt.up,
                   "both sexes filtering, down-regulated" = bs_filt.down,
                   "sex specific filtering, down-regulated" = ss_filt.down)
data <- fromList(list_input)
  
# store names
names <- colnames(data)
  
# plot
upset_gene <- ComplexUpset::upset(data, 
				  names,
				  set_sizes=(
					upset_set_size()
					+ geom_text(aes(label=..count..), hjust=1.1, stat='count')
					+ expand_limits(y=400)),
				  queries = list(upset_query("both sexes filtering, up-regulated", fill = "red"),
								 upset_query("sex specific filtering, up-regulated", fill = "red"),
								 upset_query("8 hr Low Dose Psilocybin vs Saline Down-regulated", fill = "blue"),
								 upset_query("both sexes filtering, down-regulated", fill = "blue"),
								 upset_query("sex specific filtering, down-regulated", fill = "blue")),
				  base_annotations = list('Intersection size' = (
					intersection_size(bar_number_threshold=1, width=0.5)
					+ scale_y_continuous(expand=expansion(mult=c(0, 0.05)),limits = c(0,350)) # space on top
					+ theme(
						  # hide grid lines
						  panel.grid.major=element_blank(),
						  panel.grid.minor=element_blank(),
						  # show axis lines
						  axis.line=element_line(colour='black')))),
				  stripes = upset_stripes(
					geom=geom_segment(size=12),  # make the stripes larger
					colors=c('grey95', 'white')),
				  # to prevent connectors from getting the colorured
				  # use `fill` instead of `color`, together with `shape='circle filled'`
				  matrix = intersection_matrix(
					geom=geom_point(
					  shape='circle filled',
					  size=3,
					  stroke=0.45)),
				  sort_sets=FALSE,
				  sort_intersections='descending'
				)

upset_gene <- upset_gene + ggtitle(paste0("E.21D.Y vs S.21D.Y, FDRq < ", format(thresh, nsmall = 2),
                                          ", |LFC| > ", format(myLfc, nsmall = 2)))

# save
pdf(paste0("../results/filtering_comparison/E.21D.Y_vs_S.21D.Y_FDRq_", format(thresh, nsmall = 2), 
           "_LFC_", format(myLfc, nsmall = 2), "_upset.pdf"), 
    height = 6, width = 10)
upset_gene
```

### Extract
```{r}
# convert the gene sets into a binary matrix (like UpSet plot input)
upset_data <- UpSetR::fromList(list_input)

# call the function to extract the exclusive intersection genes
exclusive_intersection_results <- get_exclusive_intersection_genes(upset_data, list_input)

# convert the list to a data.frame with two columns: Total genes and gene list
exclusive_intersection_df <- do.call(rbind, lapply(names(exclusive_intersection_results), function(x) {
  data.frame(
    Intersection = x,
    Total_Genes = exclusive_intersection_results[[x]]$total_genes,
    Gene_List = exclusive_intersection_results[[x]]$gene_list,
    stringsAsFactors = FALSE
  )
}))
exclusive_intersection_df <- 
  exclusive_intersection_df[order(exclusive_intersection_df$Total_Genes, decreasing = TRUE),]

# save
write.table(x = exclusive_intersection_df,
            file = paste0("../results/filtering_comparison/E.21D.Y_vs_S.21D.Y_FDRq_", 
                          format(thresh, nsmall = 2), "_LFC_", format(myLfc, nsmall = 2), 
                          "_results.tsv"),
            sep = "\t",
            quote = FALSE,
            col.names = TRUE,
            row.names = FALSE)
```


## E.21D.O vs S.21D.O
### Plot
```{r}
# set variables
thresh <- 0.05
myLfc <- 0
model <- "DEGs_with_hbb/"

# read tables
ss_filt <- read.delim(
  paste0("../results/both_sexes/", 
         model, "DEG_tables/E.21D.O_vs_S.21D.O_FDRq_1.00_LFC_0.00.tsv"))
bs_filt <- read.delim(
  paste0("../results/filtered_samples_both_sexes/", 
         model, "DEG_tables/E.21D.O_vs_S.21D.O_FDRq_1.00_LFC_0.00.tsv"))
rownames(ss_filt) <- ss_filt$gene_name_unique
rownames(bs_filt) <- bs_filt$gene_name_unique

# filter on pval
ss_filt <- ss_filt[ss_filt$adj.P.Val < thresh,]
bs_filt <- bs_filt[bs_filt$adj.P.Val < thresh,]

# Subset lists
ss_filt.up <- subset(ss_filt$gene_name_unique, ss_filt$logFC > myLfc)
ss_filt.down <- subset(ss_filt$gene_name_unique, ss_filt$logFC < -myLfc)
bs_filt.up <- subset(bs_filt$gene_name_unique, bs_filt$logFC > myLfc)
bs_filt.down <- subset(bs_filt$gene_name_unique, bs_filt$logFC < -myLfc)
list_input <- list("both sexes filtering, up-regulated" = bs_filt.up,
                   "sex specific filtering, up-regulated" = ss_filt.up,
                   "both sexes filtering, down-regulated" = bs_filt.down,
                   "sex specific filtering, down-regulated" = ss_filt.down)
data <- fromList(list_input)
  
# store names
names <- colnames(data)
  
# plot
upset_gene <- ComplexUpset::upset(data, 
				  names,
				  set_sizes=(
					upset_set_size()
					+ geom_text(aes(label=..count..), hjust=1.1, stat='count')
					+ expand_limits(y=400)),
				  queries = list(upset_query("both sexes filtering, up-regulated", fill = "red"),
								 upset_query("sex specific filtering, up-regulated", fill = "red"),
								 upset_query("8 hr Low Dose Psilocybin vs Saline Down-regulated", fill = "blue"),
								 upset_query("both sexes filtering, down-regulated", fill = "blue"),
								 upset_query("sex specific filtering, down-regulated", fill = "blue")),
				  base_annotations = list('Intersection size' = (
					intersection_size(bar_number_threshold=1, width=0.5)
					+ scale_y_continuous(expand=expansion(mult=c(0, 0.05)),limits = c(0,350)) # space on top
					+ theme(
						  # hide grid lines
						  panel.grid.major=element_blank(),
						  panel.grid.minor=element_blank(),
						  # show axis lines
						  axis.line=element_line(colour='black')))),
				  stripes = upset_stripes(
					geom=geom_segment(size=12),  # make the stripes larger
					colors=c('grey95', 'white')),
				  # to prevent connectors from getting the colorured
				  # use `fill` instead of `color`, together with `shape='circle filled'`
				  matrix = intersection_matrix(
					geom=geom_point(
					  shape='circle filled',
					  size=3,
					  stroke=0.45)),
				  sort_sets=FALSE,
				  sort_intersections='descending'
				)

upset_gene <- upset_gene + ggtitle(paste0("E.21D.O vs S.21D.O, FDRq < ", format(thresh, nsmall = 2),
                                          ", |LFC| > ", format(myLfc, nsmall = 2)))

# save
pdf(paste0("../results/filtering_comparison/E.21D.O_vs_S.21D.O_FDRq_", format(thresh, nsmall = 2), 
           "_LFC_", format(myLfc, nsmall = 2), "_upset.pdf"), 
    height = 6, width = 10)
upset_gene
```

### Extract
```{r}
# convert the gene sets into a binary matrix (like UpSet plot input)
upset_data <- UpSetR::fromList(list_input)

# call the function to extract the exclusive intersection genes
exclusive_intersection_results <- get_exclusive_intersection_genes(upset_data, list_input)

# convert the list to a data.frame with two columns: Total genes and gene list
exclusive_intersection_df <- do.call(rbind, lapply(names(exclusive_intersection_results), function(x) {
  data.frame(
    Intersection = x,
    Total_Genes = exclusive_intersection_results[[x]]$total_genes,
    Gene_List = exclusive_intersection_results[[x]]$gene_list,
    stringsAsFactors = FALSE
  )
}))
exclusive_intersection_df <- 
  exclusive_intersection_df[order(exclusive_intersection_df$Total_Genes, decreasing = TRUE),]

# save
write.table(x = exclusive_intersection_df,
            file = paste0("../results/filtering_comparison/E.21D.O_vs_S.21D.O_FDRq_", 
                          format(thresh, nsmall = 2), "_LFC_", format(myLfc, nsmall = 2), 
                          "_results.tsv"),
            sep = "\t",
            quote = FALSE,
            col.names = TRUE,
            row.names = FALSE)
```

# Custom volcanos
## E.2D.Y vs S.2D.Y
```{r}
# custom genes to label
goi <- c("S100a8", "S100a9", "Lcn2", "Mpeg1", "Csf3r", "Adgre1", "Vim", "Pecam1",
         "Itgam", "Sgk1", "Nfkbia", "Acot11", "Smox", "Mfsd2a")

# Output directories and file paths
out <- "../results/both_sexes/"
model <- "DEGs_with_hbb/"

# set variables
thresh <- 0.05
my.lfc <- 0

# get file list
file <- paste0(out, model, "DEG_tables/E.2D.Y_vs_S.2D.Y_FDRq_1.00_LFC_0.00.tsv")

# read DEG file
data <- read.delim(file, sep = "\t")

# subset genes to label
labels <- data[data$gene_name %in% goi,]
up <- labels[labels$logFC > 0,]
down <- labels[labels$logFC < 0,]
  
# assign colors based on thresh
color_values <- vector()
max <- nrow(data)
for(row in 1:max){
  if (data$adj.P.Val[row] < thresh){
    if (data$logFC [row] > my.lfc){
      color_values <- c(color_values, 1) # 1 when logFC > my.lfc and FDRq < thresh
    } else if (data$logFC[row] < -my.lfc){
      color_values <- c(color_values, 2) # 2 when logFC < -my.lfc and FDRq < thresh
    } else {
      color_values <- c(color_values, 3) # 3 when logFC between -my.lfc and +my.lfc and FDRq < thresh
    }
  } else {
    color_values <- c(color_values, 3) # 3 when FDRq >= thresh
  }
}
data$color_adjpval <- color_values

# manual colors for goi
data$color_adjpval[data$gene_name %in% up$gene_name] <- 4
data$color_adjpval[data$gene_name %in% down$gene_name] <- 5
data$color_adjpval <- factor(data$color_adjpval)
  
# comparison name
comparison <- gsub(paste0(out, model, "DEG_tables/"), "", file)
comparison <- gsub("_FDRq_1.00_LFC_0.00.tsv","",comparison)

# set manual colors
my_colors <- c("#ffdcdb","#e6eefc","lightgray","red","blue")
 
# set significance threshold
hadjpval <- (-log10(max(data$P.Value[data$adj.P.Val < thresh], na.rm=TRUE)))

# plot
p <-
  ggplot(data = data, 
         aes(x = logFC,  # x-axis is logFC
             y = -log10(P.Value),  # y-axis will be -log10 of P.Value
             color = color_adjpval)) +  # color is based on factored color column
  geom_point(alpha = 0.8, size = 2) +  # create scatterplot, alpha makes points transparent
  theme_bw() +  # set color theme
  theme(legend.position = "none") +  # no legend
  scale_color_manual(values = my_colors) +  # set factor colors
  labs(
    title = "", # no main title
    x = expression(log[2](FC)), # x-axis title
     y = expression(-log[10] ~ "(" ~ italic("p") ~ "-value)") # y-axis title
  ) +
  theme(axis.title.x = element_text(size = 15),
        axis.text.x = element_text(size = 15)) +
  theme(axis.title.y = element_text(size = 15),
        axis.text.y = element_text(size = 15)) +
  theme(plot.title = element_text(size = 15)) +
  geom_hline(yintercept = hadjpval,  #  horizontal line
                     colour = "#000000",
                     linetype = "dashed") +
  geom_vline(xintercept = -my.lfc,  #  vertical line
                     colour = "#000000",
                     linetype = "dashed") +
  geom_vline(xintercept = my.lfc,  #  vertical line
                     colour = "#000000",
                     linetype = "dashed") +
  ggtitle(paste0(comparison, ", adj.P.Val < ", thresh, ", LFC = ", my.lfc)) +
  geom_text_repel(data = up,
                  aes(x = logFC, y= -log10(P.Value), label = gene_name), 
                  size = 5,
                  color = "maroon", 
                  fontface="italic",
                  max.overlaps = getOption("ggrepel.max.overlaps", default = 30)
                  ) +
  geom_text_repel(data = down,
                  aes(x = logFC, y= -log10(P.Value), label = gene_name), 
                  color = "navyblue", 
                  size = 5,
                  fontface="italic",
                  max.overlaps = getOption("ggrepel.max.overlaps", default = 30)
                  ) +
  ylim(c(0,15))
 p
  
# save
path <- paste0(out, "custom_figures/", comparison, "_FDRq_", 
               format(thresh, nsmall = 2), "_LFC_",
               format(my.lfc, nsmall = 2), "_volcano.pdf")
pdf(path, height = 8, width = 8)
p
dev.off()
```

## E.2D.O vs S.2D.O
```{r}
# custom genes to label
goi <- c("S100a8", "S100a9", "Lcn2", "Mpeg1", "Csf3r", "Adgre1", "C1qa", "C1qb", 
         "C1qc", "Top2a", "Tnfsf10", "Sqle", "Hmgcr", "Insig1")

# Output directories and file paths
out <- "../results/both_sexes/"
model <- "DEGs_with_hbb/"

# set variables
thresh <- 0.05
my.lfc <- 0

# get file list
file <- paste0(out, model, "DEG_tables/E.2D.O_vs_S.2D.O_FDRq_1.00_LFC_0.00.tsv")

# read DEG file
data <- read.delim(file, sep = "\t")

# subset genes to label
labels <- data[data$gene_name %in% goi,]
up <- labels[labels$logFC > 0,]
down <- labels[labels$logFC < 0,]
  
# assign colors based on thresh
color_values <- vector()
max <- nrow(data)
for(row in 1:max){
  if (data$adj.P.Val[row] < thresh){
    if (data$logFC [row] > my.lfc){
      color_values <- c(color_values, 1) # 1 when logFC > my.lfc and FDRq < thresh
    } else if (data$logFC[row] < -my.lfc){
      color_values <- c(color_values, 2) # 2 when logFC < -my.lfc and FDRq < thresh
    } else {
      color_values <- c(color_values, 3) # 3 when logFC between -my.lfc and +my.lfc and FDRq < thresh
    }
  } else {
    color_values <- c(color_values, 3) # 3 when FDRq >= thresh
  }
}
data$color_adjpval <- color_values

# manual colors for goi
data$color_adjpval[data$gene_name %in% up$gene_name] <- 4
data$color_adjpval[data$gene_name %in% down$gene_name] <- 5
data$color_adjpval <- factor(data$color_adjpval)
  
# comparison name
comparison <- gsub(paste0(out, model, "DEG_tables/"), "", file)
comparison <- gsub("_FDRq_1.00_LFC_0.00.tsv","",comparison)

# set manual colors
my_colors <- c("#ffdcdb","#e6eefc","lightgray","red","blue")
 
# set significance threshold
hadjpval <- (-log10(max(data$P.Value[data$adj.P.Val < thresh], na.rm=TRUE)))

# plot
p <-
  ggplot(data = data, 
         aes(x = logFC,  # x-axis is logFC
             y = -log10(P.Value),  # y-axis will be -log10 of P.Value
             color = color_adjpval)) +  # color is based on factored color column
  geom_point(alpha = 0.8, size = 2) +  # create scatterplot, alpha makes points transparent
  theme_bw() +  # set color theme
  theme(legend.position = "none") +  # no legend
  scale_color_manual(values = my_colors) +  # set factor colors
  labs(
    title = "", # no main title
    x = expression(log[2](FC)), # x-axis title
     y = expression(-log[10] ~ "(" ~ italic("p") ~ "-value)") # y-axis title
  ) +
  theme(axis.title.x = element_text(size = 15),
        axis.text.x = element_text(size = 15)) +
  theme(axis.title.y = element_text(size = 15),
        axis.text.y = element_text(size = 15)) +
  theme(plot.title = element_text(size = 15)) +
  geom_hline(yintercept = hadjpval,  #  horizontal line
                     colour = "#000000",
                     linetype = "dashed") +
  geom_vline(xintercept = -my.lfc,  #  vertical line
                     colour = "#000000",
                     linetype = "dashed") +
  geom_vline(xintercept = my.lfc,  #  vertical line
                     colour = "#000000",
                     linetype = "dashed") +
  ggtitle(paste0(comparison, ", adj.P.Val < ", thresh, ", LFC = ", my.lfc)) +
  geom_text_repel(data = up,
                  aes(x = logFC, y= -log10(P.Value), label = gene_name), 
                  size = 5,
                  color = "maroon", 
                  fontface="italic",
                  max.overlaps = getOption("ggrepel.max.overlaps", default = 30)
                  ) +
  geom_text_repel(data = down,
                  aes(x = logFC, y= -log10(P.Value), label = gene_name), 
                  color = "navyblue", 
                  size = 5,
                  fontface="italic",
                  max.overlaps = getOption("ggrepel.max.overlaps", default = 30)
                  ) +
  ylim(c(0,15))
 p
  
# save
path <- paste0(out, "custom_figures/", comparison, "_FDRq_", 
               format(thresh, nsmall = 2), "_LFC_",
               format(my.lfc, nsmall = 2), "_volcano.pdf")
pdf(path, height = 8, width = 8)
p
dev.off()
```
